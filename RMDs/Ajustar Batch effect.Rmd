---
title: "Ajustar Batch effect"
author: "Fernando Lucas Ruiz (fernando.lucas@um.es)"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    highlight: kate
    number_sections: true
    theme: spacelab
    toc: true
    toc_float: true
    code_folding: "hide"
  pdf_document:
    toc: true
subtitle: Cirugía digestiva, endocrina y trasplante de órganos abdominales (IMIB)
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F)
```

```{r}
source("Librerias.R")
source("utils.R")
otus_lp_t1_t3 <- readRDS("../RDSs/otus_lp_t1_t3.RDS") %>%
    dplyr::filter(codigo != "80_Alb")

otus_bilis <- readRDS("../RDSs/otus_bilis.RDS")
otus_negative_controls <- readRDS("../RDSs/otus_negative_controls.RDS")
covs <- readRDS("../RDSs/covs.RDS") %>%
    dplyr::filter(nombre_muestra != "80_Alb")
```

# Preparar datos
## Colapsar taxonomia para random ids

```{r}
taxonomia_combinada_lp_t1_t3 <- otus_lp_t1_t3 %>%
    unite("Combined", Phylum:Species, sep = "_", remove = F)
taxonomia_combinada_bilis <- otus_bilis %>%
    unite("Combined", Phylum:Species, sep = "_", remove = F)
taxonomia_combinada_negative_controls <- otus_negative_controls %>%
    unite("Combined", Phylum:Species, sep = "_", remove = F)


taxonomia_combinada <- rbind(taxonomia_combinada_lp_t1_t3[,1:6], taxonomia_combinada_bilis[,1:6], taxonomia_combinada_negative_controls[,1:6]) 

taxonos <- unique(taxonomia_combinada$Combined)
set.seed(123)  # Para reproducibilidad
random_ids <- replicate(length(taxonos), {
  first_letter <- sample(letters, 1)  # Seleccionar una letra para el primer carácter
  rest <- sample(c(letters, 0:9), 15, replace = TRUE)  # Generar el resto del ID
  paste(c(first_letter, rest), collapse = "")  # Combinar la letra con el resto
})

taxonos_ids <- data.frame(cbind(taxonos, random_ids))

# juntar taxonos_ids a todas_muestras 
otus_lp_t1_t3_combined <- dplyr::left_join(taxonomia_combinada_lp_t1_t3, taxonos_ids, by = c("Combined" = "taxonos"))
otus_bilis_combined <- dplyr::left_join(taxonomia_combinada_bilis, taxonos_ids, by = c("Combined" = "taxonos"))
otus_negative_controls_combined <- dplyr::left_join(taxonomia_combinada_negative_controls, taxonos_ids, by = c("Combined" = "taxonos"))
```

## Controles negativos

```{r}
abundance_table_negative_control <- otus_negative_controls_combined %>%
        dplyr::group_by(random_ids, codigo) %>%
        dplyr::summarize(Count = sum(as.numeric(Count), na.rm = TRUE)) %>%
        ungroup() %>%
        pivot_wider(names_from = codigo, values_from = Count) %>%
        mutate_all(~replace_na(., 0))
    
abundance_table_negative_control <- as.data.frame(abundance_table_negative_control)
rownames(abundance_table_negative_control) <- abundance_table_negative_control$random_ids
abundance_table_negative_control <- abundance_table_negative_control %>% dplyr::select(-random_ids)
```

```{r}
samples_LP <- otus_lp_t1_t3_combined %>%
    dplyr::filter(tipo_muestra == "LP") 

pretse_LP <- prepare_TSE_data(samples_LP, covs)
```

## Quitar contaminación

```{r}
otu_combined <- merge(as.data.frame(pretse_LP$abundance_table), as.data.frame(abundance_table_negative_control), by = "row.names", all = TRUE)
rownames(otu_combined) <- otu_combined$Row.names
otu_combined$Row.names <- NULL

# Reemplazar los valores NA por ceros en la matriz combinada
otu_combined[is.na(otu_combined)] <- 0

# Crear un vector que indique qué columnas son controles (TRUE = control, FALSE = muestra real)
is_control <- c(rep(FALSE, ncol(as.data.frame(pretse_LP$abundance_table))), rep(TRUE, ncol(as.data.frame(abundance_table_negative_control))))

# Usar decontam para identificar contaminantes basados en prevalencia
contaminants_prev <- isContaminant(as.matrix(otu_combined), method = "prevalence", neg = is_control) %>%
    filter(contaminant == TRUE & p < 0.05)

head(contaminants_prev)
```

```{r}

if (nrow(contaminants_prev) != 0){
    pretse_LP$abundance_table <- pretse_LP$abundance_table %>% 
        as.data.frame() %>%
        dplyr::select(-rownames(contaminants_prev))
    
    pretse_LP$samples_metadata <- pretse_LP$samples_metadata[rownames(pretse_LP$samples_metadata) != rownames(contaminants_prev),] %>% na.omit()
}
```

## Crear dataframe guardar estadistica Permanovas

```{r}
estadisitica_ajuste_batch_df <- data.frame()
```

# Sin ajustar

## Bray

```{r}
# Calcular la matriz de distancia usando Bray-Curtis
distance_matrix <- vegdist(t(pretse_LP$abundance_table), method = "bray")

# Realizar el PCoA
pcoa_result <- cmdscale(distance_matrix, k = 2, eig = TRUE)

# Crear un data.frame con los resultados y añadir la información del batch
pcoa_data <- as.data.frame(pcoa_result$points)
colnames(pcoa_data) <- c("PCoA1", "PCoA2")
pcoa_data$batch <- pretse_LP$samples_metadata$Batch
 
ggplot(pcoa_data, aes(x = PCoA1, y = PCoA2, color = batch)) +
  geom_point(size = 1) +
  labs(title = "PCoA Bray-Curtis Sin ajustar", 
       x = paste("PCoA1",round(pcoa_result$eig[1], 2), "%"), 
       y = paste("PCoA1",round(pcoa_result$eig[2], 2), "%"), ) +
  theme_minimal()
```

```{r}
adonis_result <- adonis2(t(pretse_LP$abundance_table) ~ pretse_LP$samples_metadata$Batch)
print(adonis_result)
estadisitica_ajuste_batch_df["Sin ajustar", "Batch Varianza"] <- paste(round(adonis_result$R2[1]* 100, 2), "%")
estadisitica_ajuste_batch_df["Sin ajustar", "p.value Batch"] <- adonis_result$`Pr(>F)`[1]

cat("\n------------------\n")
adonis_result <- adonis2(t(pretse_LP$abundance_table) ~ pretse_LP$samples_metadata$Supervivencia)
print(adonis_result)
estadisitica_ajuste_batch_df["Sin ajustar", "Supervivencia Varianza"] <- paste(round(adonis_result$R2[1]* 100, 2), "%")
estadisitica_ajuste_batch_df["Sin ajustar", "p.value Supervivencia"] <- adonis_result$`Pr(>F)`[1]
```

## Loadings

```{r}
# coldata rownames match assay colnames
all(rownames(pretse_LP$samples_metadata) == colnames(pretse_LP$abundance_table)) # our dataset
##  [1] TRUE
class(pretse_LP$samples_metadata) # should be data.frame or DataFrame
##  [1] "data.frame"

# rowdata rownames match assay rownames
all(rownames(pretse_LP$tax) == rownames(pretse_LP$abundance_table)) # our dataset
##  [1] TRUE
class(pretse_LP$tax) # should be data.frame or DataFrame
##  [1] "data.frame"

# Counts
pretse_LP$abundance_table <- as.matrix(pretse_LP$abundance_table)
class(pretse_LP$abundance_table) # should be a numeric matrix
##  [1] "matrix" "array"

# Create a TreeSE
tse <- TreeSummarizedExperiment(
    assays =  SimpleList(counts = pretse_LP$abundance_table),
    colData = DataFrame(pretse_LP$samples_metadata),
    rowData = DataFrame(pretse_LP$tax))

tse <- transformAssay(tse, assay.type = "counts", method = "relabundance")
```

```{r}
variables <- colnames(colData(tse))[!(colnames(colData(tse)) %in% c("nombre_muestra", "tipo_muestra"))]
form <- as.formula(paste("assay", "~", paste(variables, collapse = "+")))

tse2 <- addRDA(
    tse,
    assay.type = "relabundance",
    formula = form,
    distance = "bray")

# Store results of PERMANOVA test
rda_info <- attr(reducedDim(tse2, "RDA"), "significance")
rda_info$permanova
rda_info$homogeneity
rda_info$permanova %>% 
    rownames_to_column(var = "variable") %>%
    dplyr::mutate(`Explained variance` = `Explained variance`*100) %>%
    dplyr::filter(variable != "Residual", variable != "Model") %>%
    arrange(desc(`Explained variance`)) %>%
    ggplot(aes(y = `Explained variance`, x = variable, fill = variable )) +
        geom_bar(stat = "identity") +
        labs(y = paste("Explained variance (%)")) +
        theme(legend.position = "none") +
        coord_flip()

plotRDA(tse2, "RDA", colour.by = "Batch")
```

## Abundancia

```{r, fig.width=30, fig.height=10}
tse2 <- agglomerateByRank(tse, "Genus")

counts <- as.data.frame(t(assay(tse2, "counts"))) %>% 
    rownames_to_column(var = "sample")


covariates <- colData(tse2) %>%
    as.data.frame()%>%
    rownames_to_column(var = "sample")

dplyr::left_join(counts, covariates, by = "sample") %>%
    dplyr::select(intersect(names(.), names(counts)), sample, -Batch) %>%
    pivot_longer(-sample, names_to = "Taxon", values_to = "Abundance") %>%
    dplyr::group_by(sample, Taxon) %>%
    dplyr::summarize(suma = sum(Abundance)) %>%
    group_by(sample) %>%
    mutate(suma_condition = sum(suma),
           relative_abundance = suma / suma_condition) %>%
    ggplot(aes(x=sample, y=relative_abundance, fill = Taxon)) +
    geom_bar(stat = "identity") +
    #scale_fill_paletteer_d("ggsci::default_igv") + 
    labs(title = "Phylum Relative Abundance", x = "Taxons", y = "Relative Abundance") +
    theme_minimal() +
    theme(
        axis.text.x = element_text(angle = 90, size = 20),
        # axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_blank(),
        #legend.position = "bottom",  
        legend.position = "none",  
        legend.text = element_text(size = 30),
        #legend.box.margin = margin(t = 10),  # Añade espacio superior para la leyenda
        legend.spacing.x = unit(0.5, 'cm'),  # Ajusta espacio entre elementos de la leyenda
        plot.title = element_text(hjust = 0.5, vjust = 10, size = 16),  # Sube el título y ajusta el tamaño
       #plot.margin = margin(t = 20)  # Añade margen superior para el título
        ) 
```

## Alpha

```{r}
index <-  c("coverage_diversity", "fisher_diversity", "faith_diversity",
    "gini_simpson_diversity", "inverse_simpson_diversity",
    "log_modulo_skewness_diversity", "shannon_diversity", "absolute_dominance",
    "dbp_dominance", "core_abundance_dominance", "gini_dominance", "dmn_dominance",
    "relative_dominance", "simpson_lambda_dominance", "camargo_evenness",
    "pielou_evenness", "simpson_evenness", "evar_evenness", "bulla_evenness",
    "ace_richness", "chao1_richness", "hill_richness", "observed_richness")

index <- index[!index %in% c("fisher_diversity", "ace_richness", "chao1_richness", "faith_diversity")]

tse <- addAlpha(
    tse, assay.type = "relabundance", index = index, name = index)
```

```{r, fig.height=10, fig.width=10, warning=FALSE}
plots <- list()
for (i in index){
    p <- plotColData(
        tse,
        i, 
        "nombre_muestra",
        colour_by = "Batch") +
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        labs(expression(Richness[Observed]))
    
    plots[[i]] <- p
    
}

# do.call(grid.arrange, c(plots[1:4], ncol = 1))
# do.call(grid.arrange, c(plots[5:8], ncol = 1))
# do.call(grid.arrange, c(plots[9:12], ncol = 1))
# do.call(grid.arrange, c(plots[13:16], ncol = 1))
# do.call(grid.arrange, c(plots[17:19], ncol = 1))
grid.arrange(plots$shannon_diversity, plots$gini_dominance, plots$hill_richness, ncol = 1)
```

```{r, fig.height=10, fig.width=10}
plots <- list()
for (i in index){
    p <- plotColData(
        tse,
        i, 
        "Batch",
        colour_by = "Batch") +
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        labs(expression(Richness[Observed]))
    
    plots[[i]] <- p
    
}

# do.call(grid.arrange, c(plots[1:4], ncol = 1))
# do.call(grid.arrange, c(plots[5:8], ncol = 1))
# do.call(grid.arrange, c(plots[9:12], ncol = 1))
# do.call(grid.arrange, c(plots[13:16], ncol = 1))
# do.call(grid.arrange, c(plots[17:19], ncol = 1))
grid.arrange(plots$shannon_diversity, plots$gini_dominance, plots$hill_richness, ncol = 1)
```



# ConQuR

### Preparar datos

```{r}
# taxa tiene que tener la taxonomia en las columnas y los samples en las filas
taxa_LP <- data.frame(t(pretse_LP$abundance_table))

# Para sacar la lista de los batch primero hay que ordenar los samples en el samples_metadata

## Asegurarse de que ambos dataframes tengan los mismos rownames
common_rows <- intersect(rownames(taxa_LP), rownames(pretse_LP$samples_metadata))

taxa_LP <- taxa_LP[common_rows, ]
samples_metadata_LP <- pretse_LP$samples_metadata[match(rownames(taxa_LP), rownames(pretse_LP$samples_metadata)), ]

covar_LP <- samples_metadata_LP 

taxa_LP <- taxa_LP[rownames(taxa_LP) %in% rownames(covar_LP), ]

batchid_LP <- as.factor(covar_LP$Batch)

covar_LP <- covar_LP %>%
    dplyr::select(-c("nombre_muestra", "Batch", "tipo_muestra"))

covar_salida <- covar_LP %>% 
    dplyr::select(MEAF_score, Supervivencia, AR, AHT, Biliary_complications) 
```

### Fine tunning automático

```{r, eval=FALSE}
result_tuned <- Tune_ConQuR(tax_tab=taxa_lp,
                           batchid=batchid_lp,
                           covariates=covar_salida,
                           batch_ref_pool=c("RUN 1", "RUN 2", "RUN 3"),
                           logistic_lasso_pool=c(T, F),
                           quantile_type_pool=c("standard", "lasso"),
                           simple_match_pool=c(T, F),
                           lambda_quantile_pool=c(NA, "2p/n", "2p/logn"),
                           interplt_pool=c(T, F),
                           frequencyL=0,
                           frequencyU=1,
                           num_core = num_cores-2)
```

Pruebas realizadas en el archivo "Buscar mejor bajada efecto Batch.Rmd"

```{r}
taxa_corrected_salida <- readRDS("../RDSs/result_tuned.RDS")
par(mfrow=c(1, 2))

Plot_PCoA(TAX=taxa_LP, factor=batchid_LP, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_corrected_salida$tax_final, factor=batchid_LP, main="ConQuR (Default), Bray-Curtis")

```

## Bray

```{r}
taxa_corrected_salida$tax_final <- taxa_corrected_salida$tax_final[!rownames(taxa_corrected_salida$tax_final) %in% "80_Alb", ]

# Calcular la matriz de distancia usando Bray-Curtis
distance_matrix <- vegdist(taxa_corrected_salida$tax_final, method = "bray")

# Realizar el PCoA
pcoa_result <- cmdscale(distance_matrix, k = 2, eig = TRUE)

# Crear un data.frame con los resultados y añadir la información del batch
pcoa_data <- as.data.frame(pcoa_result$points)
colnames(pcoa_data) <- c("PCoA1", "PCoA2")
pcoa_data$batch <- pretse_LP$samples_metadata$Batch
 
ggplot(pcoa_data, aes(x = PCoA1, y = PCoA2, color = batch)) +
  geom_point(size = 1) +
  labs(title = "PCoA Bray-Curtis ConQuR", 
       x = paste("PCoA1",round(pcoa_result$eig[1], 2), "%"), 
       y = paste("PCoA1",round(pcoa_result$eig[2], 2), "%"), ) +
  theme_minimal()
```

```{r,warning=FALSE}
adonis_result <- adonis2(taxa_corrected_salida$tax_final ~ pretse_LP$samples_metadata$Batch)
print(adonis_result)
estadisitica_ajuste_batch_df["ConQuR", "Batch Varianza"] <- paste(round(adonis_result$R2[1]* 100, 2), "%")
estadisitica_ajuste_batch_df["ConQuR", "p.value Batch"] <- adonis_result$`Pr(>F)`[1]

cat("\n------------------\n")
adonis_result <- adonis2(taxa_corrected_salida$tax_final ~ pretse_LP$samples_metadata$Supervivencia)
print(adonis_result)
estadisitica_ajuste_batch_df["ConQuR", "Supervivencia Varianza"] <- paste(round(adonis_result$R2[1]* 100, 2), "%")
estadisitica_ajuste_batch_df["ConQuR", "p.value Supervivencia"] <- adonis_result$`Pr(>F)`[1]

estadisitica_ajuste_batch_df
```

## Loadings

```{r}
# coldata rownames match assay colnames
all(rownames(pretse_LP$samples_metadata) == colnames(t(taxa_corrected_salida$tax_final))) # our dataset
##  [1] TRUE
class(pretse_LP$samples_metadata) # should be data.frame or DataFrame
##  [1] "data.frame"

# Obtén las filas comunes
common_rows <- intersect(rownames(pretse_LP$tax), rownames(t(taxa_corrected_salida$tax_final)))
# Filtra ambos dataframes para que solo contengan las filas comunes
taxa <- pretse_LP$tax[common_rows, ]
taxa_corrected_salida$tax_final <- t(taxa_corrected_salida$tax_final)[common_rows, , drop = FALSE]
taxa_corrected_salida$tax_final <- t(taxa_corrected_salida$tax_final)
# rowdata rownames match assay rownames
all(rownames(taxa) == rownames(t(taxa_corrected_salida$tax_final))) # our dataset
##  [1] TRUE
class(pretse_LP$tax) # should be data.frame or DataFrame
##  [1] "data.frame"

# Counts
class(t(taxa_corrected_salida$tax_final)) # should be a numeric matrix
##  [1] "matrix" "array"

# Create a TreeSE
tse <- TreeSummarizedExperiment(
    assays =  SimpleList(counts = t(taxa_corrected_salida$tax_final)),
    colData = DataFrame(pretse_LP$samples_metadata),
    rowData = DataFrame(taxa))

tse <- transformAssay(tse, assay.type = "counts", method = "relabundance")
```

```{r}
variables <- colnames(colData(tse))[!(colnames(colData(tse)) %in% c("nombre_muestra", "tipo_muestra"))]
form <- as.formula(paste("assay", "~", paste(variables, collapse = "+")))

tse2 <- addRDA(
    tse,
    assay.type = "relabundance",
    formula = form,
    distance = "bray")

# Store results of PERMANOVA test
rda_info <- attr(reducedDim(tse2, "RDA"), "significance")
rda_info$permanova
rda_info$homogeneity
rda_info$permanova %>% 
    rownames_to_column(var = "variable") %>%
    dplyr::mutate(`Explained variance` = `Explained variance`*100) %>%
    dplyr::filter(variable != "Residual", variable != "Model") %>%
    arrange(desc(`Explained variance`)) %>%
    ggplot(aes(y = `Explained variance`, x = variable, fill = variable )) +
        geom_bar(stat = "identity") +
        labs(y = paste("Explained variance (%)")) +
        theme(legend.position = "none") +
        coord_flip()

plotRDA(tse2, "RDA", colour.by = "Batch")
```

## Abundancia

```{r, fig.width=30, fig.height=10}
tse2 <- agglomerateByRank(tse, "Phylum")

counts <- as.data.frame(t(assay(tse2, "counts"))) %>% 
    rownames_to_column(var = "sample")


covariates <- colData(tse2) %>%
    as.data.frame()%>%
    rownames_to_column(var = "sample")

dplyr::left_join(counts, covariates, by = "sample") %>%
    dplyr::select(intersect(names(.), names(counts)), -sample, Batch) %>%
    pivot_longer(-Batch, names_to = "Taxon", values_to = "Abundance") %>%
    dplyr::group_by(Batch, Taxon) %>%
    dplyr::summarize(suma = sum(Abundance)) %>%
    group_by(Batch) %>%
    mutate(suma_condition = sum(suma),
           relative_abundance = suma / suma_condition) %>%
    ggplot(aes(x=Batch, y=relative_abundance, fill = Taxon)) +
    geom_bar(stat = "identity") +
    scale_fill_paletteer_d("ggsci::default_igv") + 
    labs(title = "Phylum Relative Abundance", x = "Taxons", y = "Relative Abundance") +
    theme_minimal() +
    theme(
        axis.text.x = element_text(angle = 90, size = 20),
        # axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_blank(),
        #legend.position = "bottom",  
        legend.position = "none",  
        legend.text = element_text(size = 30),
        #legend.box.margin = margin(t = 10),  # Añade espacio superior para la leyenda
        legend.spacing.x = unit(0.5, 'cm'),  # Ajusta espacio entre elementos de la leyenda
        plot.title = element_text(hjust = 0.5, vjust = 10, size = 16),  # Sube el título y ajusta el tamaño
       #plot.margin = margin(t = 20)  # Añade margen superior para el título
        ) 
```

## Alpha

```{r}
index <-  c("coverage_diversity", "fisher_diversity", "faith_diversity",
    "gini_simpson_diversity", "inverse_simpson_diversity",
    "log_modulo_skewness_diversity", "shannon_diversity", "absolute_dominance",
    "dbp_dominance", "core_abundance_dominance", "gini_dominance", "dmn_dominance",
    "relative_dominance", "simpson_lambda_dominance", "camargo_evenness",
    "pielou_evenness", "simpson_evenness", "evar_evenness", "bulla_evenness",
    "ace_richness", "chao1_richness", "hill_richness", "observed_richness")

index <- index[!index %in% c("fisher_diversity", "ace_richness", "chao1_richness", "faith_diversity")]

tse <- addAlpha(
    tse, assay.type = "relabundance", index = index, name = index)
```

```{r, fig.height=10, fig.width=10, warning=FALSE}
plots <- list()
for (i in index){
    p <- plotColData(
        tse,
        i, 
        "nombre_muestra",
        colour_by = "Batch") +
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        labs(expression(Richness[Observed]))
    
    plots[[i]] <- p
    
}

# do.call(grid.arrange, c(plots[1:4], ncol = 1))
# do.call(grid.arrange, c(plots[5:8], ncol = 1))
# do.call(grid.arrange, c(plots[9:12], ncol = 1))
# do.call(grid.arrange, c(plots[13:16], ncol = 1))
# do.call(grid.arrange, c(plots[17:19], ncol = 1))
grid.arrange(plots$shannon_diversity, plots$gini_dominance, plots$hill_richness, ncol = 1)
```

```{r, fig.height=10, fig.width=10}
plots <- list()
for (i in index){
    p <- plotColData(
        tse,
        i, 
        "Batch",
        colour_by = "Batch") +
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        labs(expression(Richness[Observed]))
    
    plots[[i]] <- p
    
}

# do.call(grid.arrange, c(plots[1:4], ncol = 1))
# do.call(grid.arrange, c(plots[5:8], ncol = 1))
# do.call(grid.arrange, c(plots[9:12], ncol = 1))
# do.call(grid.arrange, c(plots[13:16], ncol = 1))
# do.call(grid.arrange, c(plots[17:19], ncol = 1))
grid.arrange(plots$shannon_diversity, plots$gini_dominance, plots$hill_richness, ncol = 1)
```

# SVA
## Preparar datos

```{r}
library(sva)
matrix_data <- pretse_LP$abundance_table

covs <- pretse_LP$samples_metadata
covs$Batch <- factor(covs$Batch, levels = c("RUN 3", setdiff(unique(covs$Batch), "RUN 3")))
```

```{r}
mm <- model.matrix(~ Batch, data = covs)
nullmm <- model.matrix(~ 1, data = covs)

cat("Launching svaseq\n")
print(Sys.time())

dat <- as.matrix(matrix_data)

for (i in 1:nrow(matrix_data)) {

  for(j in 1:ncol(matrix_data)){

     if (matrix_data[i,j]<=0) matrix_data[i,j]<-0

     j=j+1
  }
  i=i+1
}

# Filtrar filas con varianza mayor a cero
matrix_data_filtered <- matrix_data[apply(matrix_data, 1, var) > 0, ]

svas  <- sva::svaseq(dat=as.matrix(matrix_data_filtered), mod=mm, mod0=nullmm)
colnames(svas$sv) <- paste0("SV", seq(1:ncol(svas$sv)))
print(Sys.time())
```

```{r}
numeric.covs <- covs[,c("Supervivencia", "Biliary_complications", "AR", "AHT")]
linp <- matrix(ncol=svas$n.sv,nrow=ncol(numeric.covs))
rownames(linp) <- colnames(numeric.covs)
colnames(linp) <- paste0("SV",1:svas$n.sv)
linp[] <- 0

for(cov in 1:ncol(numeric.covs)){

  for(sva in 1:svas$n.sv){

    if(svas$n.sv == 1)
      axis <- svas$sv

    else
      axis <- svas$sv[,sva]

    linp[cov,sva] <- cor.test(as.numeric(numeric.covs[,cov]),axis)$p.value
  }
}

smallest = -10
linp10 <- log10(linp)
linp10 <- replace(linp10, linp10 <= smallest, smallest)
tonote <- signif(linp, 1)

gplots::heatmap.2(linp10, Colv = F, Rowv = F, dendrogram = "none",
          trace = "none", symbreaks = F, symkey = F, breaks = seq(-20, 0, length.out = 100),
          key = T, colsep = NULL, rowsep = NULL, sepcolor = "black",
          sepwidth = c(0.05, 0.05), main = "Corr. of SVs and covs.",
          labCol = colnames(linp10),
          labRow = colnames(numeric.covs),
          xlab = "Surrogate variables")
```

```{r}
# We remove the SVs that are significantly associated with some covariate of interest.
linpDF <- as.data.frame(linp)
svsToRemove <- sort(unique(as.vector(unlist(apply(linp,1, function(x) which(x<0.05))))))
svas$sv <- svas$sv[, -svsToRemove]
```


```{r}
covs.rs <- as.data.frame(covs[,"Batch"])
cat("Creating residuals taking into account", paste0(colnames(svas$sv), collapse=", "), "\n")
resids <- apply(matrix_data, 1, function(y){
  lm( y ~ . , data=cbind(covs.rs,svas$sv))$residuals
})
rownames(resids) <- colnames(matrix_data)
resids[1:5, 1:5]
```

## Bray

```{r}
# Calcular la matriz de distancia usando Bray-Curtis
distance_matrix <- vegdist(resids^2, method = "bray")

# Realizar el PCoA
pcoa_result <- cmdscale(distance_matrix, k = 2, eig = TRUE)

# Crear un data.frame con los resultados y añadir la información del batch
pcoa_data <- as.data.frame(pcoa_result$points)
colnames(pcoa_data) <- c("PCoA1", "PCoA2")
pcoa_data$batch <- pretse_LP$samples_metadata$Batch
 
ggplot(pcoa_data, aes(x = PCoA1, y = PCoA2, color = batch)) +
  geom_point(size = 1) +
  labs(title = "PCoA Bray-Curtis SVA", 
       x = paste("PCoA1",round(pcoa_result$eig[1], 2), "%"), 
       y = paste("PCoA1",round(pcoa_result$eig[2], 2), "%"), ) +
  theme_minimal()
```

```{r,warning=FALSE}
adonis_result <- adonis2(resids^2 ~ pretse_LP$samples_metadata$Batch)
print(adonis_result)
estadisitica_ajuste_batch_df["SVA", "Batch Varianza"] <- paste(round(adonis_result$R2[1]* 100, 2), "%")
estadisitica_ajuste_batch_df["SVA", "p.value Batch"] <- adonis_result$`Pr(>F)`[1]

cat("\n------------------\n")
adonis_result <- adonis2(resids^2 ~ pretse_LP$samples_metadata$Supervivencia)
print(adonis_result)
estadisitica_ajuste_batch_df["SVA", "Supervivencia Varianza"] <- paste(round(adonis_result$R2[1]* 100, 2), "%")
estadisitica_ajuste_batch_df["SVA", "p.value Supervivencia"] <- adonis_result$`Pr(>F)`[1]

estadisitica_ajuste_batch_df
```

## Loadings

```{r}
# coldata rownames match assay colnames
all(rownames(pretse_LP$samples_metadata) == colnames(t(resids^2))) # our dataset
##  [1] TRUE
class(pretse_LP$samples_metadata) # should be data.frame or DataFrame
##  [1] "data.frame"

# rowdata rownames match assay rownames
all(rownames(pretse_LP$tax) == rownames(t(resids^2))) # our dataset
##  [1] TRUE
class(pretse_LP$tax) # should be data.frame or DataFrame
##  [1] "data.frame"

# Counts
class(t(resids^2)) # should be a numeric matrix
##  [1] "matrix" "array"

# Create a TreeSE
tse <- TreeSummarizedExperiment(
    assays =  SimpleList(counts = t(resids^2)),
    colData = DataFrame(pretse_LP$samples_metadata),
    rowData = DataFrame(pretse_LP$tax))

tse <- transformAssay(tse, assay.type = "counts", method = "relabundance")
```

```{r}
variables <- colnames(colData(tse))[!(colnames(colData(tse)) %in% c("nombre_muestra", "tipo_muestra"))]
form <- as.formula(paste("assay", "~", paste(variables, collapse = "+")))

tse2 <- addRDA(
    tse,
    assay.type = "relabundance",
    formula = form,
    distance = "bray")

# Store results of PERMANOVA test
rda_info <- attr(reducedDim(tse2, "RDA"), "significance")
rda_info$permanova
rda_info$homogeneity
rda_info$permanova %>% 
    rownames_to_column(var = "variable") %>%
    dplyr::mutate(`Explained variance` = `Explained variance`*100) %>%
    dplyr::filter(variable != "Residual", variable != "Model") %>%
    arrange(desc(`Explained variance`)) %>%
    ggplot(aes(y = `Explained variance`, x = variable, fill = variable )) +
        geom_bar(stat = "identity") +
        labs(y = paste("Explained variance (%)")) +
        theme(legend.position = "none") +
        coord_flip()

plotRDA(tse2, "RDA", colour.by = "Batch")
```

## Abundancia

```{r, fig.width=30, fig.height=10}
tse2 <- agglomerateByRank(tse, "Phylum")

counts <- as.data.frame(t(assay(tse2, "counts"))) %>% 
    rownames_to_column(var = "sample")


covariates <- colData(tse2) %>%
    as.data.frame()%>%
    rownames_to_column(var = "sample")

dplyr::left_join(counts, covariates, by = "sample") %>%
    dplyr::select(intersect(names(.), names(counts)), sample, -Batch) %>%
    pivot_longer(-sample, names_to = "Taxon", values_to = "Abundance") %>%
    dplyr::group_by(sample, Taxon) %>%
    dplyr::summarize(suma = sum(Abundance)) %>%
    group_by(sample) %>%
    mutate(suma_condition = sum(suma),
           relative_abundance = suma / suma_condition) %>%
    ggplot(aes(x=sample, y=relative_abundance, fill = Taxon)) +
    geom_bar(stat = "identity") +
    scale_fill_paletteer_d("ggsci::default_igv") + 
    labs(title = "Phylum Relative Abundance", x = "Taxons", y = "Relative Abundance") +
    theme_minimal() +
    theme(
        axis.text.x = element_text(angle = 90, size = 20),
        # axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_blank(),
        #legend.position = "bottom",  
        legend.position = "none",  
        legend.text = element_text(size = 30),
        #legend.box.margin = margin(t = 10),  # Añade espacio superior para la leyenda
        legend.spacing.x = unit(0.5, 'cm'),  # Ajusta espacio entre elementos de la leyenda
        plot.title = element_text(hjust = 0.5, vjust = 10, size = 16),  # Sube el título y ajusta el tamaño
       #plot.margin = margin(t = 20)  # Añade margen superior para el título
        ) 
```

## Alpha

```{r}
index <-  c("coverage_diversity", "fisher_diversity", "faith_diversity",
    "gini_simpson_diversity", "inverse_simpson_diversity",
    "log_modulo_skewness_diversity", "shannon_diversity", "absolute_dominance",
    "dbp_dominance", "core_abundance_dominance", "gini_dominance", "dmn_dominance",
    "relative_dominance", "simpson_lambda_dominance", "camargo_evenness",
    "pielou_evenness", "simpson_evenness", "evar_evenness", "bulla_evenness",
    "ace_richness", "chao1_richness", "hill_richness", "observed_richness")

index <- index[!index %in% c("fisher_diversity", "ace_richness", "chao1_richness", "faith_diversity")]

tse <- addAlpha(
    tse, assay.type = "relabundance", index = index, name = index)
```

```{r, fig.height=10, fig.width=10, warning=FALSE}
plots <- list()
for (i in index){
    p <- plotColData(
        tse,
        i, 
        "nombre_muestra",
        colour_by = "Batch") +
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        labs(expression(Richness[Observed]))
    
    plots[[i]] <- p
    
}

# do.call(grid.arrange, c(plots[1:4], ncol = 1))
# do.call(grid.arrange, c(plots[5:8], ncol = 1))
# do.call(grid.arrange, c(plots[9:12], ncol = 1))
# do.call(grid.arrange, c(plots[13:16], ncol = 1))
# do.call(grid.arrange, c(plots[17:19], ncol = 1))
grid.arrange(plots$shannon_diversity, plots$gini_dominance, plots$hill_richness, ncol = 1)
```

```{r, fig.height=10, fig.width=10}
plots <- list()
for (i in index){
    p <- plotColData(
        tse,
        i, 
        "Batch",
        colour_by = "Batch") +
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        labs(expression(Richness[Observed]))
    
    plots[[i]] <- p
    
}

# do.call(grid.arrange, c(plots[1:4], ncol = 1))
# do.call(grid.arrange, c(plots[5:8], ncol = 1))
# do.call(grid.arrange, c(plots[9:12], ncol = 1))
# do.call(grid.arrange, c(plots[13:16], ncol = 1))
# do.call(grid.arrange, c(plots[17:19], ncol = 1))
grid.arrange(plots$shannon_diversity, plots$gini_dominance, plots$hill_richness, ncol = 1)
```

# ComBat
## Preparar datos

```{r}
library(bladderbatch)
data(bladderdata)
dat <- bladderEset[1:50,]

pheno = pretse_LP$samples_metadata
edata = pretse_LP$abundance_table
batch = pheno$Batch
mod = model.matrix(~ MEAF_score + Supervivencia + AR + AHT + Biliary_complications, data=pheno)

# parametric adjustment
combat_edata1 = ComBat(dat=edata, batch=batch, mod=NULL, par.prior=TRUE, prior.plots=FALSE)

# non-parametric adjustment, mean-only version
combat_edata2 = ComBat(dat=edata, batch=batch, mod=NULL, par.prior=FALSE, mean.only=TRUE)

# reference-batch version, with covariates
combat_edata3 = ComBat(dat=edata, batch=batch, mod=mod, par.prior=T, ref.batch="RUN 3")
```

## Bray

```{r}
# Calcular la matriz de distancia usando Bray-Curtis
distance_matrix <- vegdist(t(combat_edata3), method = "bray")

# Realizar el PCoA
pcoa_result <- cmdscale(distance_matrix, k = 2, eig = TRUE)

# Crear un data.frame con los resultados y añadir la información del batch
pcoa_data <- as.data.frame(pcoa_result$points)
colnames(pcoa_data) <- c("PCoA1", "PCoA2")
pcoa_data$Batch <- pretse_LP$samples_metadata$Batch
pcoa_data$Supervivencia <- pretse_LP$samples_metadata$Supervivencia
 
ggplot(pcoa_data, aes(x = PCoA1, y = PCoA2, color = Batch)) +
  geom_point(size = 1) +
  labs(title = "PCoA Bray-Curtis ComBat", 
       x = paste("PCoA1",round(pcoa_result$eig[1], 2), "%"), 
       y = paste("PCoA1",round(pcoa_result$eig[2], 2), "%"), ) +
  theme_minimal()
```

```{r,warning=FALSE}
adonis_result <- adonis2(t(combat_edata3) ~ pretse_LP$samples_metadata$Batch)
print(adonis_result)
estadisitica_ajuste_batch_df["Combat", "Batch Varianza"] <- paste(round(adonis_result$R2[1]* 100, 2), "%")
estadisitica_ajuste_batch_df["Combat", "p.value Batch"] <- adonis_result$`Pr(>F)`[1]

cat("\n------------------\n")
adonis_result <- adonis2(t(combat_edata3) ~ pretse_LP$samples_metadata$Supervivencia)
print(adonis_result)
estadisitica_ajuste_batch_df["Combat", "Supervivencia Varianza"] <- paste(round(adonis_result$R2[1]* 100, 2), "%")
estadisitica_ajuste_batch_df["Combat", "p.value Supervivencia"] <- adonis_result$`Pr(>F)`[1]

estadisitica_ajuste_batch_df
```

## Loadings

```{r}
# coldata rownames match assay colnames
all(rownames(pretse_LP$samples_metadata) == colnames(combat_edata3)) # our dataset
##  [1] TRUE
class(pretse_LP$samples_metadata) # should be data.frame or DataFrame
##  [1] "data.frame"

# rowdata rownames match assay rownames
all(rownames(pretse_LP$tax) == rownames(combat_edata3)) # our dataset
##  [1] TRUE
class(pretse_LP$tax) # should be data.frame or DataFrame
##  [1] "data.frame"

# Counts
class(combat_edata3) # should be a numeric matrix
##  [1] "matrix" "array"

# Create a TreeSE
tse <- TreeSummarizedExperiment(
    assays =  SimpleList(counts = combat_edata3^2),
    colData = DataFrame(pretse_LP$samples_metadata),
    rowData = DataFrame(pretse_LP$tax))

tse <- transformAssay(tse, assay.type = "counts", method = "relabundance")
```

```{r}
variables <- colnames(colData(tse))[!(colnames(colData(tse)) %in% c("nombre_muestra", "tipo_muestra"))]
form <- as.formula(paste("assay", "~", paste(variables, collapse = "+")))

tse2 <- addRDA(
    tse,
    assay.type = "relabundance",
    formula = form,
    distance = "bray")

# Store results of PERMANOVA test
rda_info <- attr(reducedDim(tse2, "RDA"), "significance")
rda_info$permanova
rda_info$homogeneity
rda_info$permanova %>% 
    rownames_to_column(var = "variable") %>%
    dplyr::mutate(`Explained variance` = `Explained variance`*100) %>%
    dplyr::filter(variable != "Residual", variable != "Model") %>%
    arrange(desc(`Explained variance`)) %>%
    ggplot(aes(y = `Explained variance`, x = variable, fill = variable )) +
        geom_bar(stat = "identity") +
        labs(y = paste("Explained variance (%)")) +
        theme(legend.position = "none") +
        coord_flip()

plotRDA(tse2, "RDA", colour.by = "Batch")
```

## Abundancia

```{r, fig.width=30, fig.height=10}
tse2 <- agglomerateByRank(tse, "Phylum")

counts <- as.data.frame(t(assay(tse2, "counts"))) %>% 
    rownames_to_column(var = "sample")


covariates <- colData(tse2) %>%
    as.data.frame()%>%
    rownames_to_column(var = "sample")

dplyr::left_join(counts, covariates, by = "sample") %>%
    dplyr::select(intersect(names(.), names(counts)), -sample, Batch) %>%
    pivot_longer(-Batch, names_to = "Taxon", values_to = "Abundance") %>%
    dplyr::group_by(Batch, Taxon) %>%
    dplyr::summarize(suma = sum(Abundance)) %>%
    group_by(Batch) %>%
    mutate(suma_condition = sum(suma),
           relative_abundance = suma / suma_condition) %>%
    ggplot(aes(x=Batch, y=relative_abundance, fill = Taxon)) +
    geom_bar(stat = "identity") +
    scale_fill_paletteer_d("ggsci::default_igv") + 
    labs(title = "Phylum Relative Abundance", x = "Taxons", y = "Relative Abundance") +
    theme_minimal() +
    theme(
        axis.text.x = element_text(angle = 90, size = 20),
        # axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_blank(),
        #legend.position = "bottom",  
        legend.position = "none",  
        legend.text = element_text(size = 30),
        #legend.box.margin = margin(t = 10),  # Añade espacio superior para la leyenda
        legend.spacing.x = unit(0.5, 'cm'),  # Ajusta espacio entre elementos de la leyenda
        plot.title = element_text(hjust = 0.5, vjust = 10, size = 16),  # Sube el título y ajusta el tamaño
       #plot.margin = margin(t = 20)  # Añade margen superior para el título
        ) 
```

## Alpha

```{r}
index <-  c("shannon_diversity", "gini_dominance", "dmn_dominance",
    "relative_dominance", "simpson_lambda_dominance", "camargo_evenness",
    "pielou_evenness", "simpson_evenness", "evar_evenness", "bulla_evenness",
    "ace_richness", "chao1_richness", "hill_richness", "observed_richness")

index <- index[!index %in% c("fisher_diversity", "ace_richness", "chao1_richness", "faith_diversity")]

tse <- addAlpha(
    tse, assay.type = "relabundance", index = index, name = index)
```

```{r, fig.height=10, fig.width=10, warning=FALSE}
plots <- list()
for (i in index){
    p <- plotColData(
        tse,
        i, 
        "nombre_muestra",
        colour_by = "Batch") +
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        labs(expression(Richness[Observed]))
    
    plots[[i]] <- p
    
}

# do.call(grid.arrange, c(plots[1:4], ncol = 1))
# do.call(grid.arrange, c(plots[5:8], ncol = 1))
# do.call(grid.arrange, c(plots[9:12], ncol = 1))
# do.call(grid.arrange, c(plots[13:16], ncol = 1))
# do.call(grid.arrange, c(plots[17:19], ncol = 1))
grid.arrange(plots$shannon_diversity, plots$gini_dominance, plots$hill_richness, ncol = 1)
```

```{r, fig.height=10, fig.width=10}
plots <- list()
for (i in index){
    p <- plotColData(
        tse,
        i, 
        "Batch",
        colour_by = "Batch") +
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        labs(expression(Richness[Observed]))
    
    plots[[i]] <- p
    
}

# do.call(grid.arrange, c(plots[1:4], ncol = 1))
# do.call(grid.arrange, c(plots[5:8], ncol = 1))
# do.call(grid.arrange, c(plots[9:12], ncol = 1))
# do.call(grid.arrange, c(plots[13:16], ncol = 1))
# do.call(grid.arrange, c(plots[17:19], ncol = 1))
grid.arrange(plots$shannon_diversity, plots$gini_dominance, plots$hill_richness, ncol = 1)
```

# MaAsLin2
## Preparar datos

```{r}
# library(Maaslin2)
# 
# df_input_data <- pretse_LP$abundance_table %>% t() %>% as.data.frame()
# df_input_metadata <- pretse_LP$samples_metadata
# 
# fit_data2 <- Maaslin2(
#     input_data = df_input_data, 
#     input_metadata = df_input_metadata, 
#     output = "../maaslin2batch", 
#     fixed_effects = c("Batch"), reference = c("Batch", "RUN 3"))
```

## Bray

```{r}
# # Calcular la matriz de distancia usando Bray-Curtis
# distance_matrix <- vegdist(t(fit_data2$fitted^2), method = "bray")
# 
# # Realizar el PCoA
# pcoa_result <- cmdscale(distance_matrix, k = 2, eig = TRUE)
# 
# # Crear un data.frame con los resultados y añadir la información del batch
# pcoa_data <- as.data.frame(pcoa_result$points)
# colnames(pcoa_data) <- c("PCoA1", "PCoA2")
# pcoa_data$batch <- pretse_LP$samples_metadata$Batch
# 
# ggplot(pcoa_data, aes(x = PCoA1, y = PCoA2, color = batch)) +
#   geom_point(size = 1) +
#   labs(title = "PCoA Bray-Curtis ConQuR", 
#        x = paste("PCoA1",round(pcoa_result$eig[1], 2), "%"), 
#        y = paste("PCoA1",round(pcoa_result$eig[2], 2), "%"), ) +
#   theme_minimal()
```

# MMUPHin
## Preparar datos

```{r}

library(MMUPHin)

##########################
# Create sample metadata #
##########################
data_meta <- pretse_LP$samples_metadata
data_meta$Batch <- factor(data_meta$Batch, levels = c("RUN 3", setdiff(unique(data_meta$Batch), "RUN 3")))


###########################
# Create Species Features #
###########################
# Transpose the abundance matrix and change the value of abundance data to
# proportion unit
data_abd <- pretse_LP$abundance_table

# Match the individuals in the data_abd
data_abd <- data_abd[, colnames(data_abd) %in% rownames(data_meta)]

# Use adjust_batch to correct for differences in the five studies, while
# controlling for the effect of cases versus control (variable resvar in
# data_meta).
fit_adjust_batch <- adjust_batch(
    feature_abd = data_abd,
    batch = "Batch",
    covariates = NULL,
    data = data_meta,
    control = list(verbose = FALSE, diagnostic_plot = NULL))

data_abd_adj <- fit_adjust_batch$feature_abd_adj


```

## Bray

```{r}
# Calcular la matriz de distancia usando Bray-Curtis
distance_matrix <- vegdist(t(data_abd_adj), method = "bray")

# Realizar el PCoA
pcoa_result <- cmdscale(distance_matrix, k = 2, eig = TRUE)

# Crear un data.frame con los resultados y añadir la información del batch
pcoa_data <- as.data.frame(pcoa_result$points)
colnames(pcoa_data) <- c("PCoA1", "PCoA2")
pcoa_data$batch <- pretse_LP$samples_metadata$Batch
 
ggplot(pcoa_data, aes(x = PCoA1, y = PCoA2, color = batch)) +
  geom_point(size = 1) +
  labs(title = "PCoA Bray-Curtis MMUPHIN", 
       x = paste("PCoA1",round(pcoa_result$eig[1], 2), "%"), 
       y = paste("PCoA1",round(pcoa_result$eig[2], 2), "%"), ) +
  theme_minimal()
```

```{r,warning=FALSE}
adonis_result <- adonis2(t(data_abd_adj) ~ pretse_LP$samples_metadata$Batch)
print(adonis_result)
estadisitica_ajuste_batch_df["MMUPHin", "Batch Varianza"] <- paste(round(adonis_result$R2[1]* 100, 2), "%")
estadisitica_ajuste_batch_df["MMUPHin", "p.value Batch"] <- adonis_result$`Pr(>F)`[1]

cat("\n------------------\n")
adonis_result <- adonis2(t(data_abd_adj) ~ pretse_LP$samples_metadata$Supervivencia)
print(adonis_result)
estadisitica_ajuste_batch_df["MMUPHin", "Supervivencia Varianza"] <- paste(round(adonis_result$R2[1]* 100, 2), "%")
estadisitica_ajuste_batch_df["MMUPHin", "p.value Supervivencia"] <- adonis_result$`Pr(>F)`[1]

estadisitica_ajuste_batch_df
```

## Loadings

```{r}
# coldata rownames match assay colnames
all(rownames(pretse_LP$samples_metadata) == colnames(combat_edata3^2)) # our dataset
##  [1] TRUE
class(pretse_LP$samples_metadata) # should be data.frame or DataFrame
##  [1] "data.frame"

# rowdata rownames match assay rownames
all(rownames(pretse_LP$tax) == rownames(combat_edata3^2)) # our dataset
##  [1] TRUE
class(pretse_LP$tax) # should be data.frame or DataFrame
##  [1] "data.frame"

# Counts
class(combat_edata3^2) # should be a numeric matrix
##  [1] "matrix" "array"

# Create a TreeSE
tse <- TreeSummarizedExperiment(
    assays =  SimpleList(counts = combat_edata3^2),
    colData = DataFrame(pretse_LP$samples_metadata),
    rowData = DataFrame(pretse_LP$tax))

tse <- transformAssay(tse, assay.type = "counts", method = "relabundance")
```

```{r}
variables <- colnames(colData(tse))[!(colnames(colData(tse)) %in% c("nombre_muestra", "tipo_muestra"))]
form <- as.formula(paste("assay", "~", paste(variables, collapse = "+")))

tse2 <- addRDA(
    tse,
    assay.type = "relabundance",
    formula = form,
    distance = "bray")

# Store results of PERMANOVA test
rda_info <- attr(reducedDim(tse2, "RDA"), "significance")
rda_info$permanova
rda_info$homogeneity
rda_info$permanova %>% 
    rownames_to_column(var = "variable") %>%
    dplyr::mutate(`Explained variance` = `Explained variance`*100) %>%
    dplyr::filter(variable != "Residual", variable != "Model") %>%
    arrange(desc(`Explained variance`)) %>%
    ggplot(aes(y = `Explained variance`, x = variable, fill = variable )) +
        geom_bar(stat = "identity") +
        labs(y = paste("Explained variance (%)")) +
        theme(legend.position = "none") +
        coord_flip()

plotRDA(tse2, "RDA", colour.by = "Batch")
```

## Abundancia

```{r, fig.width=30, fig.height=10}
tse2 <- agglomerateByRank(tse, "Phylum")

counts <- as.data.frame(t(assay(tse2, "counts"))) %>% 
    rownames_to_column(var = "sample")


covariates <- colData(tse2) %>%
    as.data.frame()%>%
    rownames_to_column(var = "sample")

dplyr::left_join(counts, covariates, by = "sample") %>%
    dplyr::select(intersect(names(.), names(counts)), sample, -Batch) %>%
    pivot_longer(-sample, names_to = "Taxon", values_to = "Abundance") %>%
    dplyr::group_by(sample, Taxon) %>%
    dplyr::summarize(suma = sum(Abundance)) %>%
    group_by(sample) %>%
    mutate(suma_condition = sum(suma),
           relative_abundance = suma / suma_condition) %>%
    ggplot(aes(x=sample, y=relative_abundance, fill = Taxon)) +
    geom_bar(stat = "identity") +
    scale_fill_paletteer_d("ggsci::default_igv") + 
    labs(title = "Phylum Relative Abundance", x = "Taxons", y = "Relative Abundance") +
    theme_minimal() +
    theme(
        axis.text.x = element_text(angle = 90, size = 20),
        # axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_blank(),
        legend.position = "bottom",  
        #legend.position = "none",  
        legend.text = element_text(size = 30),
        #legend.box.margin = margin(t = 10),  # Añade espacio superior para la leyenda
        legend.spacing.x = unit(0.5, 'cm'),  # Ajusta espacio entre elementos de la leyenda
        plot.title = element_text(hjust = 0.5, vjust = 10, size = 16),  # Sube el título y ajusta el tamaño
       #plot.margin = margin(t = 20)  # Añade margen superior para el título
        ) 
```

## Alpha

```{r}
index <-  c("coverage_diversity", "fisher_diversity", "faith_diversity",
    "gini_simpson_diversity", "inverse_simpson_diversity",
    "log_modulo_skewness_diversity", "shannon_diversity", "absolute_dominance",
    "dbp_dominance", "core_abundance_dominance", "gini_dominance", "dmn_dominance",
    "relative_dominance", "simpson_lambda_dominance", "camargo_evenness",
    "pielou_evenness", "simpson_evenness", "evar_evenness", "bulla_evenness",
    "ace_richness", "chao1_richness", "hill_richness", "observed_richness")

index <- index[!index %in% c("fisher_diversity", "ace_richness", "chao1_richness", "faith_diversity")]

tse <- addAlpha(
    tse, assay.type = "relabundance", index = index, name = index)
```

```{r, fig.height=10, fig.width=10, warning=FALSE}
plots <- list()
for (i in index){
    p <- plotColData(
        tse,
        i, 
        "nombre_muestra",
        colour_by = "Batch") +
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        labs(expression(Richness[Observed]))
    
    plots[[i]] <- p
    
}

# do.call(grid.arrange, c(plots[1:4], ncol = 1))
# do.call(grid.arrange, c(plots[5:8], ncol = 1))
# do.call(grid.arrange, c(plots[9:12], ncol = 1))
# do.call(grid.arrange, c(plots[13:16], ncol = 1))
# do.call(grid.arrange, c(plots[17:19], ncol = 1))
grid.arrange(plots$shannon_diversity, plots$gini_dominance, plots$hill_richness, ncol = 1)
```

```{r, fig.height=10, fig.width=10}
plots <- list()
for (i in index){
    p <- plotColData(
        tse,
        i, 
        "Batch",
        colour_by = "Batch") +
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        labs(expression(Richness[Observed]))
    
    plots[[i]] <- p
    
}

# do.call(grid.arrange, c(plots[1:4], ncol = 1))
# do.call(grid.arrange, c(plots[5:8], ncol = 1))
# do.call(grid.arrange, c(plots[9:12], ncol = 1))
# do.call(grid.arrange, c(plots[13:16], ncol = 1))
# do.call(grid.arrange, c(plots[17:19], ncol = 1))
grid.arrange(plots$shannon_diversity, plots$gini_dominance, plots$hill_richness, ncol = 1)
```
---
title: "ComBat"
author: "Fernando Lucas Ruiz (fernando.lucas@um.es)"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    highlight: kate
    number_sections: true
    theme: spacelab
    toc: true
    toc_float: true
    code_folding: "hide"
  pdf_document:
    toc: true
subtitle: Cirugía digestiva, endocrina y trasplante de órganos abdominales (IMIB)
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F)
```

```{r}
source("Librerias.R")
source("utils.R")
otus_lp_t1_t3 <- readRDS("../RDSs/otus_lp_t1_t3.RDS")
otus_bilis <- readRDS("../RDSs/otus_bilis.RDS")
otus_negative_controls <- readRDS("../RDSs/otus_negative_controls.RDS")
covs <- readRDS("../RDSs/covs.RDS")
```



# Colapsar taxonomia para random ids

```{r}
taxonomia_combinada_lp_t1_t3 <- otus_lp_t1_t3 %>%
    unite("Combined", Phylum:Species, sep = "_", remove = F)
taxonomia_combinada_bilis <- otus_bilis %>%
    unite("Combined", Phylum:Species, sep = "_", remove = F)
taxonomia_combinada_negative_controls <- otus_negative_controls %>%
    unite("Combined", Phylum:Species, sep = "_", remove = F)


taxonomia_combinada <- rbind(taxonomia_combinada_lp_t1_t3[,1:6], taxonomia_combinada_bilis[,1:6], taxonomia_combinada_negative_controls[,1:6]) 

taxonos <- unique(taxonomia_combinada$Combined)
set.seed(123)  # Para reproducibilidad
random_ids <- replicate(length(taxonos), {
  first_letter <- sample(letters, 1)  # Seleccionar una letra para el primer carácter
  rest <- sample(c(letters, 0:9), 15, replace = TRUE)  # Generar el resto del ID
  paste(c(first_letter, rest), collapse = "")  # Combinar la letra con el resto
})

taxonos_ids <- data.frame(cbind(taxonos, random_ids))

# juntar taxonos_ids a todas_muestras 
otus_lp_t1_t3_combined <- dplyr::left_join(taxonomia_combinada_lp_t1_t3, taxonos_ids, by = c("Combined" = "taxonos"))
otus_bilis_combined <- dplyr::left_join(taxonomia_combinada_bilis, taxonos_ids, by = c("Combined" = "taxonos"))
otus_negative_controls_combined <- dplyr::left_join(taxonomia_combinada_negative_controls, taxonos_ids, by = c("Combined" = "taxonos"))
```

# Controles negativos

```{r}
abundance_table_negative_control <- otus_negative_controls_combined %>%
        dplyr::group_by(random_ids, codigo) %>%
        dplyr::summarize(Count = sum(as.numeric(Count), na.rm = TRUE)) %>%
        ungroup() %>%
        pivot_wider(names_from = codigo, values_from = Count) %>%
        mutate_all(~replace_na(., 0))
    
abundance_table_negative_control <- as.data.frame(abundance_table_negative_control)
rownames(abundance_table_negative_control) <- abundance_table_negative_control$random_ids
abundance_table_negative_control <- abundance_table_negative_control %>% select(-random_ids)
```

# LP

## Preparar datos

```{r}
samples_LP <- otus_lp_t1_t3_combined %>%
    dplyr::filter(tipo_muestra == "LP") 

pretse_LP <- prepare_TSE_data(samples_LP, covs)
```

## Quitar contaminación

```{r}
otu_combined <- merge(as.data.frame(pretse_LP$abundance_table), as.data.frame(abundance_table_negative_control), by = "row.names", all = TRUE)
rownames(otu_combined) <- otu_combined$Row.names
otu_combined$Row.names <- NULL

# Reemplazar los valores NA por ceros en la matriz combinada
otu_combined[is.na(otu_combined)] <- 0

# Crear un vector que indique qué columnas son controles (TRUE = control, FALSE = muestra real)
is_control <- c(rep(FALSE, ncol(as.data.frame(pretse_LP$abundance_table))), rep(TRUE, ncol(as.data.frame(abundance_table_negative_control))))

# Usar decontam para identificar contaminantes basados en prevalencia
contaminants_prev <- isContaminant(as.matrix(otu_combined), method = "prevalence", neg = is_control) %>%
    filter(contaminant == TRUE & p < 0.05)

head(contaminants_prev)
```

```{r}

if (nrow(contaminants_prev) != 0){
    pretse_LP$abundance_table <- pretse_LP$abundance_table %>% 
        as.data.frame() %>%
        select(-rownames(contaminants_prev))
    
    pretse_LP$samples_metadata <- pretse_LP$samples_metadata[rownames(pretse_LP$samples_metadata) != rownames(contaminants_prev),] %>% na.omit()
}
```

## Quitar batch effect

```{r}
library(sva)
matrix_data <- pretse_LP$abundance_table

# Definir batch y covariables
batch_vector <- pretse_LP$samples_metadata$Batch
covariate_data <- pretse_LP$samples_metadata[,c(-1:-3)]

# Ejecutar ComBat
combat_data <- ComBat(
  dat = matrix_data,
  batch = batch_vector,
  mod = model.matrix(~ Supervivencia + AR + AHT + Biliary_complications + Graft_disfunct, data = covariate_data),
  par.prior = TRUE,
  prior.plots = FALSE
)

# Cargar el paquete vegan para PERMANOVA
library(vegan)

# Realizar PERMANOVA en los datos ajustados
adonis_result <- adonis2(t(combat_data) ~ batch_vector)
print(adonis_result)

adonis_result <- adonis2(t(combat_data) ~ covariate_data$Supervivencia)
print(adonis_result)

```

```{r}
# Realizar PCA en los datos ajustados
pca <- prcomp(t(pretse_LP$abundance_table))
pca_data <- as.data.frame(pca$x)
pca_data$batch <- batch_vector

# Graficar
p1 <- ggplot(pca_data, aes(x = PC1, y = PC2, color = batch)) +
  geom_point(size = 3) +
  labs(title = "PCA de datos ajustados por batch") +
  theme_minimal()

# Realizar PCA en los datos ajustados
pca <- prcomp(t(combat_data))
pca_data <- as.data.frame(pca$x)
pca_data$batch <- batch_vector

# Graficar
p2 <- ggplot(pca_data, aes(x = PC1, y = PC2, color = batch)) +
  geom_point(size = 3) +
  labs(title = "PCA de datos ajustados por batch") +
  theme_minimal()

p1 + p2 


dfaaaa <- pca$rotation %>% as.data.frame()
factoextra::fviz_pca_biplot(pca)
```

```{r}
pretse_LP$tax["fkq8zsxmhdse3oa3", ]
```


```{r}
# Calcular la matriz de distancia usando Bray-Curtis
distance_matrix <- vegdist(t(pretse_LP$abundance_table), method = "bray")

# Realizar el PCoA
pcoa_result <- cmdscale(distance_matrix, k = 2, eig = TRUE)

# Crear un data.frame con los resultados y añadir la información del batch
pcoa_data <- as.data.frame(pcoa_result$points)
colnames(pcoa_data) <- c("PCoA1", "PCoA2")
pcoa_data$batch <- batch_vector

 
p1 <- ggplot(pcoa_data, aes(x = PCoA1, y = PCoA2, color = batch)) +
  geom_point(size = 1) +
  labs(title = "PCoA de datos ajustados por batch", x = "PCoA1", y = "PCoA2") +
  theme_minimal()
# Calcular la matriz de distancia usando Bray-Curtis
distance_matrix <- vegdist(t(combat_data), method = "bray")

# Realizar el PCoA
pcoa_result <- cmdscale(distance_matrix, k = 2, eig = TRUE)

# Crear un data.frame con los resultados y añadir la información del batch
pcoa_data <- as.data.frame(pcoa_result$points)
colnames(pcoa_data) <- c("PCoA1", "PCoA2")
pcoa_data$batch <- batch_vector

 
p2 <- ggplot(pcoa_data, aes(x = PCoA1, y = PCoA2, color = batch)) +
  geom_point(size = 1) +
  labs(title = "PCoA de datos ajustados por batch", x = "PCoA1", y = "PCoA2") +
  theme_minimal()

p1 + p2


```

```{r}
pretse_LP$samples_metadata <- pretse_LP$samples_metadata[rownames(pretse_LP$samples_metadata) != "4_Alb",]
pretse_LP$abundance_table <- pretse_LP$abundance_table[, colnames(pretse_LP$abundance_table) != "4_Alb"]
```

```{r}
library(sva)
matrix_data <- pretse_LP$abundance_table

# Definir batch y covariables
batch_vector <- pretse_LP$samples_metadata$Batch
covariate_data <- pretse_LP$samples_metadata[,c(-1:-3)]

# Ejecutar ComBat
combat_data <- ComBat(
  dat = matrix_data,
  batch = batch_vector,
  mod = model.matrix(~ Supervivencia, data = covariate_data),
  par.prior = F,
  prior.plots = T
)

# Cargar el paquete vegan para PERMANOVA
library(vegan)

# Realizar PERMANOVA en los datos ajustados
adonis_result <- adonis2(t(combat_data) ~ batch_vector)
print(adonis_result)

adonis_result <- adonis2(t(combat_data) ~ covariate_data$Supervivencia)
print(adonis_result)

```

```{r}
# Realizar PCA en los datos ajustados
pca <- prcomp(t(pretse_LP$abundance_table))
pca_data <- as.data.frame(pca$x)
pca_data$batch <- batch_vector

# Graficar
p1 <- ggplot(pca_data, aes(x = PC1, y = PC2, color = batch)) +
  geom_point(size = 1) +
  labs(title = "PCA de datos ajustados por batch") +
  theme_minimal()

# Realizar PCA en los datos ajustados
pca <- prcomp(t(combat_data))
pca_data <- as.data.frame(pca$x)
pca_data$batch <- batch_vector

# Graficar
p2 <- ggplot(pca_data, aes(x = PC1, y = PC2, color = batch)) +
  geom_point(size = 1) +
  labs(title = "PCA de datos ajustados por batch") +
  theme_minimal()

p1 + p2 


dfaaaa <- pca$rotation %>% as.data.frame()
factoextra::fviz_pca_biplot(pca)
factoextra::fviz_pca_ind(pca, addEllipses = T, habillage = pretse_LP$samples_metadata$Supervivencia)
```
Bray-Curtis: Es una de las más utilizadas en estudios de comunidades microbianas, ya que tiene en cuenta la abundancia relativa y es robusta frente a las variaciones en la cantidad de datos entre muestras. Es una medida semi-métrica, lo que significa que considera la estructura de los datos sin enfocarse en la abundancia absoluta. Ideal para datos de conteo en metagenómica y estudios de diversidad beta.

La distancia Euclidiana es menos recomendada en metagenómica humana principalmente porque no toma en cuenta las características composicionales de los datos microbiológicos, como los valores de abundancia relativa.

```{r}
# Calcular la matriz de distancia usando Bray-Curtis
distance_matrix <- vegdist(t(pretse_LP$abundance_table), method = "bray")

# Realizar el PCoA
pcoa_result <- cmdscale(distance_matrix, k = 2, eig = TRUE)

# Crear un data.frame con los resultados y añadir la información del batch
pcoa_data <- as.data.frame(pcoa_result$points)
colnames(pcoa_data) <- c("PCoA1", "PCoA2")
pcoa_data$batch <- pretse_LP$samples_metadata$Batch

 
p1 <- ggplot(pcoa_data, aes(x = PCoA1, y = PCoA2, color = batch)) +
  geom_point(size = 1) +
  labs(title = "PCoA de datos ajustados por batch", x = "PCoA1", y = "PCoA2") +
  theme_minimal()
# Calcular la matriz de distancia usando Bray-Curtis
distance_matrix <- vegdist(t(combat_data), method = "bray")

# Realizar el PCoA
pcoa_result <- cmdscale(distance_matrix, k = 2, eig = TRUE)

# Crear un data.frame con los resultados y añadir la información del batch
pcoa_data <- as.data.frame(pcoa_result$points)
colnames(pcoa_data) <- c("PCoA1", "PCoA2")
pcoa_data$batch <- batch_vector

 
p2 <- ggplot(pcoa_data, aes(x = PCoA1, y = PCoA2, color = batch)) +
  geom_point(size = 1) +
  labs(title = "PCoA de datos ajustados por batch", x = "PCoA1", y = "PCoA2") +
  theme_minimal()

p1 + p2


```






---
title: "ConQuR"
author: "Fernando Lucas Ruiz (fernando.lucas@um.es)"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    highlight: kate
    number_sections: true
    theme: spacelab
    toc: true
    toc_float: true
    code_folding: "hide"
  pdf_document:
    toc: true
subtitle: Cirugía digestiva, endocrina y trasplante de órganos abdominales (IMIB)
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F)
```

```{r, eval=FALSE}
install.packages("doParallel")
devtools::install_github("wdl2459/ConQuR")
install.packages("coda.base")
```

# LP y tejidos
## ConQuR sin filtrado

```{r}
# taxa tiene que tener la taxonomia en las columnas y los samples en las filas
taxa <- data.frame(t(abundance_table))

# Para sacar la lista de los batch primero hay que ordenar los samples en el samples_metadata

## Asegurarse de que ambos dataframes tengan los mismos rownames
common_rows <- intersect(rownames(taxa), rownames(samples_metadata))

taxa <- taxa[common_rows, ]
samples_metadata <- samples_metadata[match(rownames(taxa), rownames(samples_metadata)), ]

head(taxa)
head(samples_metadata)

batchid <- as.factor(samples_metadata$Batch)
summary(batchid)

covar <- samples_metadata %>%
    dplyr::select(-c("nombre_muestra", "Batch"))

```

```{r, eval=FALSE}
taxa_corrected_todas <- ConQuR(tax_tab=taxa, batchid=batchid, covariates=covar, batch_ref="RUN 46", num_core = num_cores-2)

saveRDS(taxa_corrected_todas, "taxa_corrected_todas.RDS")
```

```{r}
taxa_corrected_todas <- readRDS("taxa_corrected_todas.RDS")
par(mfrow=c(2, 2))

Plot_PCoA(TAX=taxa, factor=batchid, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_corrected_todas, factor=batchid, main="ConQuR (Default), Bray-Curtis")
#Plot_PCoA(TAX=taxa_corrected2, factor=batchid, main="ConQuR (Penalized), Bray-Curtis")

Plot_PCoA(TAX=taxa, factor=batchid, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_corrected_todas, factor=batchid, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")
#Plot_PCoA(TAX=taxa_corrected2, factor=batchid, dissimilarity="Aitch", main="ConQuR (Penalized), Aitchison")
```
```{r}
permanovas <- data.frame(matrix(ncol = 4, nrow = 0))
colnames(permanovas) <- c("Batch Bray-Curtis", "Key Bray-Curtis", "Batch Aitchinson", "Key Aitchinson")
```

```{r}
permanova_taxa <- PERMANOVA_R2(TAX=taxa, batchid=batchid, covariates=covar, key_index=1)
permanova_taxa_todas_variables <- PERMANOVA_R2(TAX=taxa_corrected_todas, batchid=batchid, covariates=covar, key_index=1)

permanovas["Original",1] = permanova_taxa$tab_count[1,1]
permanovas["Original",2] = permanova_taxa$tab_count[2,1]
permanovas["Original",3] = permanova_taxa$tab_rel[1,1]
permanovas["Original",4] = permanova_taxa$tab_rel[2,1]

permanovas["Corregida todas variables",1] = permanova_taxa_todas_variables$tab_count[1,1]
permanovas["Corregida todas variables",2] = permanova_taxa_todas_variables$tab_count[2,1]
permanovas["Corregida todas variables",3] = permanova_taxa_todas_variables$tab_rel[1,1]
permanovas["Corregida todas variables",4] = permanova_taxa_todas_variables$tab_rel[2,1]

reactable::reactable(round(permanovas, 3)*100)
```

## ConQuR filtrado
### Datos donante

```{r}
# Ahora las covariables
covar_donante <- samples_metadata %>%
    dplyr::select(Donación, Sexo_D, Edad_D, BMI_D, GOT_D, GPT_D, PT_ACT_D, Cold_Isch, Machine_SRR, Machine_NRP, Machine_DBD, NRP_Total)
```

```{r, eval=FALSE}
taxa_corrected_donante <- ConQuR(tax_tab=taxa, batchid=batchid, covariates=covar_donante, batch_ref="RUN 46", num_core = num_cores-2)

saveRDS(taxa_corrected_donante, "taxa_corrected_donante.RDS")
```

```{r}
taxa_corrected_donante <- readRDS("taxa_corrected_donante.RDS")
par(mfrow=c(2, 2))

Plot_PCoA(TAX=taxa, factor=batchid, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_corrected_donante, factor=batchid, main="ConQuR (Default), Bray-Curtis")
#Plot_PCoA(TAX=taxa_corrected2, factor=batchid, main="ConQuR (Penalized), Bray-Curtis")

Plot_PCoA(TAX=taxa, factor=batchid, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_corrected_donante, factor=batchid, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")
#Plot_PCoA(TAX=taxa_corrected2, factor=batchid, dissimilarity="Aitch", main="ConQuR (Penalized), Aitchison")
```

```{r}
permanova_taxa_corrected_donante <- PERMANOVA_R2(TAX=taxa_corrected_donante, batchid=batchid, covariates=covar_donante, key_index=1)

permanovas["Varibles donante",1] = permanova_taxa_corrected_donante$tab_count[1,1]
permanovas["Varibles donante",2] = permanova_taxa_corrected_donante$tab_count[2,1]
permanovas["Varibles donante",3] = permanova_taxa_corrected_donante$tab_rel[1,1]
permanovas["Varibles donante",4] = permanova_taxa_corrected_donante$tab_rel[2,1]

reactable::reactable(round(permanovas, 3)*100)
```

### Datos donante filtrado

```{r}
# Ahora las covariables
covar_donante_2 <- samples_metadata %>%
    dplyr::select(Donación, Sexo_D, Edad_D, BMI_D)
```

```{r, eval=FALSE}
taxa_corrected_donante_2 <- ConQuR(tax_tab=taxa, batchid=batchid, covariates=covar_donante_2, batch_ref="RUN 46", num_core = num_cores-2)

saveRDS(taxa_corrected_donante_2, "taxa_corrected_donante_2.RDS")
```

```{r}
taxa_corrected_donante_2 <- readRDS("taxa_corrected_donante_2.RDS")
par(mfrow=c(2, 3))

Plot_PCoA(TAX=taxa, factor=batchid, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_corrected_donante_2, factor=batchid, main="ConQuR (Default), Bray-Curtis")

Plot_PCoA(TAX=taxa, factor=batchid, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_corrected_donante_2, factor=batchid, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")

```

```{r}
permanova_taxa_corrected_donante_2 <- PERMANOVA_R2(TAX=taxa_corrected_donante_2, batchid=batchid, covariates=covar_donante_2, key_index=1)

permanovas["Donación, Sexo_D, Edad_D, BMI_D",1] = permanova_taxa_corrected_donante_2$tab_count[1,1]
permanovas["Donación, Sexo_D, Edad_D, BMI_D",2] = permanova_taxa_corrected_donante_2$tab_count[2,1]
permanovas["Donación, Sexo_D, Edad_D, BMI_D",3] = permanova_taxa_corrected_donante_2$tab_rel[1,1]
permanovas["Donación, Sexo_D, Edad_D, BMI_D",4] = permanova_taxa_corrected_donante_2$tab_rel[2,1]

reactable::reactable(round(permanovas, 3)*100)
```

#### Donación, Sexo_D, Edad_D

```{r}
# Ahora las covariables
covar_donante_3 <- samples_metadata %>%
    dplyr::select(Donación, Sexo_D, Edad_D)
```

```{r, eval=FALSE}
options(warn=-1)
taxa_corrected_donante_3 <- ConQuR(tax_tab=taxa, batchid=batchid, covariates=covar_donante_3, batch_ref="RUN 46", num_core = num_cores-2)

saveRDS(taxa_corrected_donante_3, "taxa_corrected_donante_3.RDS")
```

```{r}
taxa_corrected_donante_3 <- readRDS("taxa_corrected_donante_3.RDS")
par(mfrow=c(2, 2))

Plot_PCoA(TAX=taxa, factor=batchid, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_corrected_donante_3, factor=batchid, main="ConQuR (Default), Bray-Curtis")

Plot_PCoA(TAX=taxa, factor=batchid, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_corrected_donante_3, factor=batchid, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")

```

```{r}
permanova_taxa_corrected_donante_3 <- PERMANOVA_R2(TAX=taxa_corrected_donante_3, batchid=batchid, covariates=covar_donante_3, key_index=1)

permanovas["Donación, Sexo_D, Edad_D",1] = permanova_taxa_corrected_donante_3$tab_count[1,1]
permanovas["Donación, Sexo_D, Edad_D",2] = permanova_taxa_corrected_donante_3$tab_count[2,1]
permanovas["Donación, Sexo_D, Edad_D",3] = permanova_taxa_corrected_donante_3$tab_rel[1,1]
permanovas["Donación, Sexo_D, Edad_D",4] = permanova_taxa_corrected_donante_3$tab_rel[2,1]

reactable::reactable(round(permanovas, 3)*100)
```

#### Donación, Sexo_D, BMI_D

```{r}
# Ahora las covariables
covar_donante_3 <- samples_metadata %>%
    dplyr::select(Donación, Sexo_D, BMI_D)
```

```{r, eval=FALSE}
options(warn=-1)
taxa_corrected_donante_3 <- ConQuR(tax_tab=taxa, batchid=batchid, covariates=covar_donante_3, batch_ref="RUN 46", num_core = num_cores-2)

saveRDS(taxa_corrected_donante_3, "taxa_corrected_donante_4.RDS")
```

```{r}
taxa_corrected_donante_3 <- readRDS("taxa_corrected_donante_4.RDS")
par(mfrow=c(2, 2))

Plot_PCoA(TAX=taxa, factor=batchid, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_corrected_donante_3, factor=batchid, main="ConQuR (Default), Bray-Curtis")

Plot_PCoA(TAX=taxa, factor=batchid, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_corrected_donante_3, factor=batchid, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")

```

```{r}
permanova_taxa_corrected_donante_3 <- PERMANOVA_R2(TAX=taxa_corrected_donante_3, batchid=batchid, covariates=covar_donante_3, key_index=1)

permanovas["Donación, Sexo_D, Edad_D",1] = permanova_taxa_corrected_donante_3$tab_count[1,1]
permanovas["Donación, Sexo_D, Edad_D",2] = permanova_taxa_corrected_donante_3$tab_count[2,1]
permanovas["Donación, Sexo_D, Edad_D",3] = permanova_taxa_corrected_donante_3$tab_rel[1,1]
permanovas["Donación, Sexo_D, Edad_D",4] = permanova_taxa_corrected_donante_3$tab_rel[2,1]

reactable::reactable(round(permanovas, 3)*100)
```

#### Donación, Edad_D, BMI_D

```{r}
# Ahora las covariables
covar_donante_3 <- samples_metadata %>%
    dplyr::select(Donación, Edad_D, BMI_D)
```

```{r, eval=FALSE}
options(warn=-1)
taxa_corrected_donante_3 <- ConQuR(tax_tab=taxa, batchid=batchid, covariates=covar_donante_3, batch_ref="RUN 46", num_core = num_cores-2)

saveRDS(taxa_corrected_donante_3, "taxa_corrected_donante_5.RDS")
```

```{r}
taxa_corrected_donante_3 <- readRDS("taxa_corrected_donante_5.RDS")
par(mfrow=c(2, 2))

Plot_PCoA(TAX=taxa, factor=batchid, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_corrected_donante_3, factor=batchid, main="ConQuR (Default), Bray-Curtis")

Plot_PCoA(TAX=taxa, factor=batchid, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_corrected_donante_3, factor=batchid, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")

```

```{r}
permanova_taxa_corrected_donante_3 <- PERMANOVA_R2(TAX=taxa_corrected_donante_3, batchid=batchid, covariates=covar_donante_3, key_index=1)

permanovas["Donación, Edad_D, BMI_D",1] = permanova_taxa_corrected_donante_3$tab_count[1,1]
permanovas["Donación, Edad_D, BMI_D",2] = permanova_taxa_corrected_donante_3$tab_count[2,1]
permanovas["Donación, Edad_D, BMI_D",3] = permanova_taxa_corrected_donante_3$tab_rel[1,1]
permanovas["Donación, Edad_D, BMI_D",4] = permanova_taxa_corrected_donante_3$tab_rel[2,1]

reactable::reactable(round(permanovas, 3)*100)
```

#### Sexo_D, Edad_D, BMI_D

```{r}
# Ahora las covariables
covar_donante_3 <- samples_metadata %>%
    dplyr::select(Sexo_D, Edad_D, BMI_D)
```

```{r, eval=FALSE}
options(warn=-1)
taxa_corrected_donante_3 <- ConQuR(tax_tab=taxa, batchid=batchid, covariates=covar_donante_3, batch_ref="RUN 46", num_core = num_cores-2)

saveRDS(taxa_corrected_donante_3, "taxa_corrected_donante_6.RDS")
```

```{r}
taxa_corrected_donante_3 <- readRDS("taxa_corrected_donante_6.RDS")
par(mfrow=c(2, 2))

Plot_PCoA(TAX=taxa, factor=batchid, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_corrected_donante_3, factor=batchid, main="ConQuR (Default), Bray-Curtis")

Plot_PCoA(TAX=taxa, factor=batchid, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_corrected_donante_3, factor=batchid, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")

```

```{r}
permanova_taxa_corrected_donante_3 <- PERMANOVA_R2(TAX=taxa_corrected_donante_3, batchid=batchid, covariates=covar_donante_3, key_index=1)

permanovas["Sexo_D, Edad_D, BMI_D",1] = permanova_taxa_corrected_donante_3$tab_count[1,1]
permanovas["Sexo_D, Edad_D, BMI_D",2] = permanova_taxa_corrected_donante_3$tab_count[2,1]
permanovas["Sexo_D, Edad_D, BMI_D",3] = permanova_taxa_corrected_donante_3$tab_rel[1,1]
permanovas["Sexo_D, Edad_D, BMI_D",4] = permanova_taxa_corrected_donante_3$tab_rel[2,1]

reactable::reactable(round(permanovas, 3)*100)
```

#### Donación, Sexo_D

```{r}
# Ahora las covariables
covar_donante_3 <- samples_metadata %>%
    dplyr::select(Donación, Sexo_D)
```

```{r, eval=FALSE}
options(warn=-1)
taxa_corrected_donante_3 <- ConQuR(tax_tab=taxa, batchid=batchid, covariates=covar_donante_3, batch_ref="RUN 46", num_core = num_cores-2)

saveRDS(taxa_corrected_donante_3, "taxa_corrected_donante_7.RDS")
```

```{r}
taxa_corrected_donante_3 <- readRDS("taxa_corrected_donante_7.RDS")
par(mfrow=c(2, 2))

Plot_PCoA(TAX=taxa, factor=batchid, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_corrected_donante_3, factor=batchid, main="ConQuR (Default), Bray-Curtis")

Plot_PCoA(TAX=taxa, factor=batchid, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_corrected_donante_3, factor=batchid, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")

```

```{r}
permanova_taxa_corrected_donante_3 <- PERMANOVA_R2(TAX=taxa_corrected_donante_3, batchid=batchid, covariates=covar_donante_3, key_index=1)

permanovas["Donación, Sexo_D",1] = permanova_taxa_corrected_donante_3$tab_count[1,1]
permanovas["Donación, Sexo_D",2] = permanova_taxa_corrected_donante_3$tab_count[2,1]
permanovas["Donación, Sexo_D",3] = permanova_taxa_corrected_donante_3$tab_rel[1,1]
permanovas["Donación, Sexo_D",4] = permanova_taxa_corrected_donante_3$tab_rel[2,1]

reactable::reactable(round(permanovas, 3)*100)
```

#### Donación, Edad_D

```{r}
# Ahora las covariables
covar_donante_3 <- samples_metadata %>%
    dplyr::select(Donación, Edad_D)
```

```{r, eval=FALSE}
options(warn=-1)
taxa_corrected_donante_3 <- ConQuR(tax_tab=taxa, batchid=batchid, covariates=covar_donante_3, batch_ref="RUN 46", num_core = num_cores-2)

saveRDS(taxa_corrected_donante_3, "taxa_corrected_donante_8.RDS")
```

```{r}
taxa_corrected_donante_3 <- readRDS("taxa_corrected_donante_8.RDS")
par(mfrow=c(2, 2))

Plot_PCoA(TAX=taxa, factor=batchid, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_corrected_donante_3, factor=batchid, main="ConQuR (Default), Bray-Curtis")

Plot_PCoA(TAX=taxa, factor=batchid, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_corrected_donante_3, factor=batchid, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")

```

```{r}
permanova_taxa_corrected_donante_3 <- PERMANOVA_R2(TAX=taxa_corrected_donante_3, batchid=batchid, covariates=covar_donante_3, key_index=1)

permanovas["Donación, Edad_D",1] = permanova_taxa_corrected_donante_3$tab_count[1,1]
permanovas["Donación, Edad_D",2] = permanova_taxa_corrected_donante_3$tab_count[2,1]
permanovas["Donación, Edad_D",3] = permanova_taxa_corrected_donante_3$tab_rel[1,1]
permanovas["Donación, Edad_D",4] = permanova_taxa_corrected_donante_3$tab_rel[2,1]

reactable::reactable(round(permanovas, 3)*100)
```

#### Donación, BMI_D

```{r}
# Ahora las covariables
covar_donante_3 <- samples_metadata %>%
    dplyr::select(Donación, BMI_D)
```

```{r, eval=FALSE}
options(warn=-1)
taxa_corrected_donante_3 <- ConQuR(tax_tab=taxa, batchid=batchid, covariates=covar_donante_3, batch_ref="RUN 46", num_core = num_cores-2)

saveRDS(taxa_corrected_donante_3, "taxa_corrected_donante_9.RDS")
```

```{r}
taxa_corrected_donante_3 <- readRDS("taxa_corrected_donante_9.RDS")
par(mfrow=c(2, 2))

Plot_PCoA(TAX=taxa, factor=batchid, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_corrected_donante_3, factor=batchid, main="ConQuR (Default), Bray-Curtis")

Plot_PCoA(TAX=taxa, factor=batchid, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_corrected_donante_3, factor=batchid, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")

```

```{r}
permanova_taxa_corrected_donante_3 <- PERMANOVA_R2(TAX=taxa_corrected_donante_3, batchid=batchid, covariates=covar_donante_3, key_index=1)

permanovas["Donación, BMI_D",1] = permanova_taxa_corrected_donante_3$tab_count[1,1]
permanovas["Donación, BMI_D",2] = permanova_taxa_corrected_donante_3$tab_count[2,1]
permanovas["Donación, BMI_D",3] = permanova_taxa_corrected_donante_3$tab_rel[1,1]
permanovas["Donación, BMI_D",4] = permanova_taxa_corrected_donante_3$tab_rel[2,1]

reactable::reactable(round(permanovas, 3)*100)
```

#### Sexo_D, Edad_D

```{r}
# Ahora las covariables
covar_donante_3 <- samples_metadata %>%
    dplyr::select(Sexo_D, Edad_D)
```

```{r, eval=FALSE}
options(warn=-1)
taxa_corrected_donante_3 <- ConQuR(tax_tab=taxa, batchid=batchid, covariates=covar_donante_3, batch_ref="RUN 46", num_core = num_cores-2)

saveRDS(taxa_corrected_donante_3, "taxa_corrected_donante_10.RDS")
```

```{r}
taxa_corrected_donante_3 <- readRDS("taxa_corrected_donante_10.RDS")
par(mfrow=c(2, 2))

Plot_PCoA(TAX=taxa, factor=batchid, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_corrected_donante_3, factor=batchid, main="ConQuR (Default), Bray-Curtis")

Plot_PCoA(TAX=taxa, factor=batchid, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_corrected_donante_3, factor=batchid, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")

```

```{r}
permanova_taxa_corrected_donante_3 <- PERMANOVA_R2(TAX=taxa_corrected_donante_3, batchid=batchid, covariates=covar_donante_3, key_index=1)

permanovas["Sexo_D, Edad_D",1] = permanova_taxa_corrected_donante_3$tab_count[1,1]
permanovas["Sexo_D, Edad_D",2] = permanova_taxa_corrected_donante_3$tab_count[2,1]
permanovas["Sexo_D, Edad_D",3] = permanova_taxa_corrected_donante_3$tab_rel[1,1]
permanovas["Sexo_D, Edad_D",4] = permanova_taxa_corrected_donante_3$tab_rel[2,1]

reactable::reactable(round(permanovas, 3)*100)
```

#### Sexo_D, BMI_D

```{r}
# Ahora las covariables
covar_donante_3 <- samples_metadata %>%
    dplyr::select(Sexo_D, BMI_D)
```

```{r, eval=FALSE}
options(warn=-1)
taxa_corrected_donante_3 <- ConQuR(tax_tab=taxa, batchid=batchid, covariates=covar_donante_3, batch_ref="RUN 46", num_core = num_cores-2)

saveRDS(taxa_corrected_donante_3, "taxa_corrected_donante_11.RDS")
```

```{r}
taxa_corrected_donante_3 <- readRDS("taxa_corrected_donante_11.RDS")
par(mfrow=c(2, 2))

Plot_PCoA(TAX=taxa, factor=batchid, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_corrected_donante_3, factor=batchid, main="ConQuR (Default), Bray-Curtis")

Plot_PCoA(TAX=taxa, factor=batchid, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_corrected_donante_3, factor=batchid, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")

```

```{r}
permanova_taxa_corrected_donante_3 <- PERMANOVA_R2(TAX=taxa_corrected_donante_3, batchid=batchid, covariates=covar_donante_3, key_index=1)

permanovas["Sexo_D, BMI_D",1] = permanova_taxa_corrected_donante_3$tab_count[1,1]
permanovas["Sexo_D, BMI_D",2] = permanova_taxa_corrected_donante_3$tab_count[2,1]
permanovas["Sexo_D, BMI_D",3] = permanova_taxa_corrected_donante_3$tab_rel[1,1]
permanovas["Sexo_D, BMI_D",4] = permanova_taxa_corrected_donante_3$tab_rel[2,1]

reactable::reactable(round(permanovas, 3)*100)
```

#### Edad_D, BMI_D

```{r}
# Ahora las covariables
covar_donante_3 <- samples_metadata %>%
    dplyr::select(Edad_D, BMI_D)
```

```{r, eval=FALSE}
options(warn=-1)
taxa_corrected_donante_3 <- ConQuR(tax_tab=taxa, batchid=batchid, covariates=covar_donante_3, batch_ref="RUN 46", num_core = num_cores-2)

saveRDS(taxa_corrected_donante_3, "taxa_corrected_donante_12.RDS")
```

```{r}
taxa_corrected_donante_3 <- readRDS("taxa_corrected_donante_12.RDS")
par(mfrow=c(2, 2))

Plot_PCoA(TAX=taxa, factor=batchid, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_corrected_donante_3, factor=batchid, main="ConQuR (Default), Bray-Curtis")

Plot_PCoA(TAX=taxa, factor=batchid, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_corrected_donante_3, factor=batchid, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")

```

```{r}
permanova_taxa_corrected_donante_3 <- PERMANOVA_R2(TAX=taxa_corrected_donante_3, batchid=batchid, covariates=covar_donante_3, key_index=1)

permanovas["Edad_D, BMI_D",1] = permanova_taxa_corrected_donante_3$tab_count[1,1]
permanovas["Edad_D, BMI_D",2] = permanova_taxa_corrected_donante_3$tab_count[2,1]
permanovas["Edad_D, BMI_D",3] = permanova_taxa_corrected_donante_3$tab_rel[1,1]
permanovas["Edad_D, BMI_D",4] = permanova_taxa_corrected_donante_3$tab_rel[2,1]

reactable::reactable(round(permanovas, 3)*100)
```

### Supervivencia 

```{r}
# Ahora las covariables
covar_supervivencia <- samples_metadata %>%
    dplyr::select("Supervivencia")
```

```{r, eval=FALSE}
taxa_corrected_supervivencia <- ConQuR(tax_tab=taxa, batchid=batchid, covariates=covar_supervivencia, batch_ref="RUN 46", num_core = num_cores-2)

saveRDS(taxa_corrected_supervivencia, "taxa_corrected_supervivencia.RDS")
```

```{r}
taxa_corrected_supervivencia <- readRDS("../RDSs/taxa_corrected_supervivencia.RDS")
par(mfrow=c(2, 2))

Plot_PCoA(TAX=taxa, factor=batchid, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_corrected_supervivencia, factor=batchid, main="ConQuR (Default), Bray-Curtis")

Plot_PCoA(TAX=taxa, factor=batchid, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_corrected_supervivencia, factor=batchid, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")

```

```{r}
permanova_taxa_corrected_supervivencia <- PERMANOVA_R2(TAX=taxa_corrected_supervivencia, batchid=batchid, covariates=covar_supervivencia, key_index=1)

permanovas["Supervivencia",1] = permanova_taxa_corrected_supervivencia$tab_count[1,1]
permanovas["Supervivencia",2] = permanova_taxa_corrected_supervivencia$tab_count[2,1]
permanovas["Supervivencia",3] = permanova_taxa_corrected_supervivencia$tab_rel[1,1]
permanovas["Supervivencia",4] = permanova_taxa_corrected_supervivencia$tab_rel[2,1]

reactable::reactable(round(permanovas, 3)*100)
```

#### Supervivencia con datos donante

```{r}
# Ahora las covariables
covar_supervivencia_2 <- samples_metadata %>%
    dplyr::select(Donación, Sexo_D, Edad_D, BMI_D, Supervivencia)
```

```{r, eval=FALSE}
taxa_corrected_supervivencia_2 <- ConQuR(tax_tab=taxa, batchid=batchid, covariates=covar_supervivencia_2, batch_ref="RUN 46", num_core = num_cores-2)

saveRDS(taxa_corrected_supervivencia_2, "../RDSs/taxa_corrected_supervivencia_2.RDS")
```

```{r}
taxa_corrected_supervivencia_2 <- readRDS("../RDSs/taxa_corrected_supervivencia_2.RDS")
par(mfrow=c(2, 2))

Plot_PCoA(TAX=taxa, factor=batchid, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_corrected_supervivencia_2, factor=batchid, main="ConQuR (Default), Bray-Curtis")

Plot_PCoA(TAX=taxa, factor=batchid, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_corrected_supervivencia_2, factor=batchid, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")

```

```{r}
permanova_taxa_corrected_supervivencia_2 <- PERMANOVA_R2(TAX=taxa_corrected_supervivencia_2, batchid=batchid, covariates=covar_supervivencia_2, key_index=1)

permanovas["Supervivencia, Donación, Sexo_D, Edad_D, BMI_D",1] = permanova_taxa_corrected_supervivencia_2$tab_count[1,1]
permanovas["Supervivencia, Donación, Sexo_D, Edad_D, BMI_D",2] = permanova_taxa_corrected_supervivencia_2$tab_count[2,1]
permanovas["Supervivencia, Donación, Sexo_D, Edad_D, BMI_D",3] = permanova_taxa_corrected_supervivencia_2$tab_rel[1,1]
permanovas["Supervivencia, Donación, Sexo_D, Edad_D, BMI_D",4] = permanova_taxa_corrected_supervivencia_2$tab_rel[2,1]

reactable::reactable(round(permanovas, 3)*100)
```

### Tipo de muestra

```{r}
# Ahora las covariables
covar_muestra <- samples_metadata %>%
    dplyr::select(tipo_muestra)
```

```{r, eval=FALSE}
taxa_corrected_muestra <- ConQuR(tax_tab=taxa, batchid=batchid, covariates=covar_muestra, batch_ref="RUN 46", num_core = num_cores-2)

saveRDS(taxa_corrected_muestra, "taxa_corrected_muestra.RDS")
```

```{r}
taxa_corrected_muestra <- readRDS("../RDSs/taxa_corrected_muestra.RDS")
par(mfrow=c(2, 2))

Plot_PCoA(TAX=taxa, factor=batchid, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_corrected_muestra, factor=batchid, main="ConQuR (Default), Bray-Curtis")

Plot_PCoA(TAX=taxa, factor=batchid, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_corrected_muestra, factor=batchid, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")
```

```{r}
permanova_taxa_corrected_muestra <- PERMANOVA_R2(TAX=taxa_corrected_muestra, batchid=batchid, covariates=covar_muestra, key_index=1)

permanovas["tipo muestra",1] = permanova_taxa_corrected_muestra$tab_count[1,1]
permanovas["tipo muestra",2] = permanova_taxa_corrected_muestra$tab_count[2,1]
permanovas["tipo muestra",3] = permanova_taxa_corrected_muestra$tab_rel[1,1]
permanovas["tipo muestra",4] = permanova_taxa_corrected_muestra$tab_rel[2,1]

reactable::reactable(round(permanovas, 3)*100)
```

### Variables de Salida

```{r}
# Ahora las covariables
covar_salida <- samples_metadata %>%
    dplyr::select(Supervivencia, MEAF_score, AR, AHT, Biliary_complications)
```

```{r, eval=FALSE}
taxa_corrected_salida <- ConQuR(tax_tab=taxa, batchid=batchid, covariates=covar_salida, batch_ref="RUN 46", num_core = num_cores-2)

saveRDS(taxa_corrected_salida, "../RDSs/taxa_corrected_salida.RDS")
```

```{r}
taxa_corrected_salida <- readRDS("../RDSs/taxa_corrected_salida.RDS")

par(mfrow=c(2, 2))

Plot_PCoA(TAX=taxa, factor=batchid, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_corrected_salida, factor=batchid, main="ConQuR (Default), Bray-Curtis")

Plot_PCoA(TAX=taxa, factor=batchid, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_corrected_salida, factor=batchid, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")

```

```{r}
permanova_taxa_corrected_salida <- PERMANOVA_R2(TAX=taxa_corrected_salida, batchid=batchid, covariates=covar_salida, key_index=1)

permanovas["Supervivencia, MEAF_score, AR, AHT, Biliary_complications",1] = permanova_taxa_corrected_salida$tab_count[1,1]
permanovas["Supervivencia, MEAF_score, AR, AHT, Biliary_complications",2] = permanova_taxa_corrected_salida$tab_count[2,1]
permanovas["Supervivencia, MEAF_score, AR, AHT, Biliary_complications",3] = permanova_taxa_corrected_salida$tab_rel[1,1]
permanovas["Supervivencia, MEAF_score, AR, AHT, Biliary_complications",4] = permanova_taxa_corrected_salida$tab_rel[2,1]

reactable::reactable(round(permanovas, 3)*100)
```

### Programa para ver la mejor variable para reducir batch

```{r, eval=FALSE}
# Manipulación de datos
library(tidyverse)

# Efectos de Batch
library(ConQuR)
library(doParallel)
library(coda.base)
num_cores <- detectCores()
registerDoParallel(cores=num_cores-2)


plots_Bray <- list()
plots_Aitch <- list()
permanovas_por_run <- list()

covar_conqur <- samples_metadata %>%
    dplyr::select(tipo_muestra, 
                  Donación, 
                  Sexo_D, 
                  Edad_D, 
                  MEAF_score,
                  Supervivencia)


for (j in levels(batchid)) {
    
    print(paste0("Analizando el RUN = ", j))
    
    contador <- 1
    
    plots_variable_Bray <- list()
    plots_variable_Aitch <- list()
    
    permanovas <- data.frame(matrix(ncol = 8, nrow = 0))
    colnames(permanovas) <- c("Original Batch Bray-Curtis", "Corrected Batch Bray-Curtis", "Original Key Bray-Curtis", "Corrected Key Bray-Curtis", "Original Batch Aitchinson", "Corrected Batch Aitchinson", "Original Key Aitchinson", "Corrected Key Aitchinson")
    
    for (i in names(covar_conqur)) {
        
        if (i == "nombre_muestra" | i == "Batch"){
            contador <- contador + 1
            next
        }
        
        print(paste0("Analizando la variable ", i))
        
        tryCatch({
            # Selecciona la covariable y realiza el procesamiento
            covariable <- covar_conqur %>%
                dplyr::select(i)
            
            # Corrección de taxa usando ConQuR
            taxa_corregida <- ConQuR(tax_tab=taxa, 
                                     batchid=batchid, 
                                     covariates=covariable, 
                                     batch_ref=j, 
                                     num_core = num_cores-2
            )
            
            print(paste0("ConQuR de ", i , " con Batch_ref = ", j, " finalizado "))
            
            # Realiza el plot para Bray-Curtis
            p <- Plot_PCoA(TAX=taxa_corregida, factor=batchid, main=paste("ConQuR,", i, "Bray-Curtis"))
            plots_variable_Bray[[i]] <- p
            
            # Realiza el plot para Aitchison
            p <- Plot_PCoA(TAX=taxa_corregida, factor=batchid, dissimilarity="Aitch", main=paste("ConQuR,", i, "Aitchison"))
            plots_variable_Aitch[[i]] <- p
            
            # Corre PERMANOVA para las versiones original y corregida
            permanova_original <- PERMANOVA_R2(TAX=taxa, batchid=batchid, covariates=covar, key_index=contador)
            permanova_variable <- PERMANOVA_R2(TAX=taxa_corregida, batchid=batchid, covariates=covariable, key_index=1)
            
            # Guarda los resultados de PERMANOVA en el data frame
            permanovas[i, "Original Batch Bray-Curtis"] = permanova_original$tab_count[1,1]
            permanovas[i, "Corrected Batch Bray-Curtis"] = permanova_variable$tab_count[1,1]
            permanovas[i, "Original Key Bray-Curtis"] = permanova_original$tab_rel[2,1]
            permanovas[i, "Corrected Key Bray-Curtis"] = permanova_variable$tab_rel[2,1]
            permanovas[i, "Original Batch Aitchinson"] = permanova_original$tab_count[1,1]
            permanovas[i, "Corrected Batch Aitchinson"] = permanova_variable$tab_count[1,1]
            permanovas[i, "Original Key Aitchinson"] = permanova_original$tab_rel[2,1]
            permanovas[i, "Corrected Key Aitchinson"] = permanova_variable$tab_rel[2,1]
            
        }, error = function(e) {
            # Manejo del error, imprime un mensaje y continúa
            print(paste("Error en la variable", i, "del RUN=", j, ":", e$message))
        })
        
        contador <- contador + 1
    }
    
    plots_Bray[[j]] <- plots_variable_Bray
    plots_Aitch[[j]] <- plots_variable_Aitch
    
    permanovas_por_run[[j]] <- permanovas
    
}


saveRDS(object = permanovas_por_run, "permanovas_variables_ConQuR.RDS")
saveRDS(object = plots_Bray, "plots_Bray_variables_ConQuR.RDS")
saveRDS(object = plots_Aitch, "plots_Aitch_variables_ConQuR.RDS")

print(paste0("Proceso con todas las muestras finalizado"))
```

```{r}
permanovas_variables <- readRDS("permanovas_variables_ConQuR.RDS")
plots_Bray_variables <- readRDS("plots_Bray_variables_ConQuR.RDS")
plots_Aitch_variables <- readRDS("plots_Aitch_variables_ConQuR.RDS")
```

```{r}

for (i in 1:length(permanovas_variables)){
    print(reactable::reactable(round(permanovas_variables[[i]], 3)*100))
}

```



# LP
## ConQuR sin filtrado

```{r}
covar_lp <- samples_metadata %>%
    dplyr::filter(tipo_muestra == "LP")

taxa_lp <- taxa[rownames(taxa) %in% rownames(covar_lp), ]


batchid_lp <- as.factor(covar_lp$Batch)

covar_lp <- covar_lp %>%
    dplyr::select(-c("nombre_muestra", "Batch", "tipo_muestra"))

```

```{r, eval=FALSE}
taxa_corrected_todas_lp <- ConQuR(tax_tab=taxa_lp, batchid=batchid_lp, covariates=covar_lp, batch_ref="RUN 46", num_core = num_cores-2)

saveRDS(taxa_corrected_todas_lp, "taxa_corrected_todas_lp.RDS")
```

```{r}
taxa_corrected_todas_lp <- readRDS("taxa_corrected_todas_lp.RDS")
par(mfrow=c(2, 2))

Plot_PCoA(TAX=taxa_lp, factor=batchid_lp, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_corrected_todas_lp, factor=batchid_lp, main="ConQuR (Default), Bray-Curtis")

Plot_PCoA(TAX=taxa_lp, factor=batchid_lp, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_corrected_todas_lp, factor=batchid_lp, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")
```

```{r}
permanova_taxa_todas_variables_lp <- PERMANOVA_R2(TAX=taxa_corrected_todas_lp, batchid=batchid_lp, covariates=covar_lp, key_index=2)

permanovas["LP todas variables",1] = permanova_taxa_todas_variables_lp$tab_count[1,1]
permanovas["LP todas variables",2] = permanova_taxa_todas_variables_lp$tab_count[2,1]
permanovas["LP todas variables",3] = permanova_taxa_todas_variables_lp$tab_rel[1,1]
permanovas["LP todas variables",4] = permanova_taxa_todas_variables_lp$tab_rel[2,1]

reactable::reactable(round(permanovas, 3)*100)
```

## ConQuR filtrado
### Datos donante

```{r}
# Ahora las covariables
covar_donante_lp <- covar_lp %>%
    dplyr::select(Donación, Sexo_D, Edad_D, BMI_D, GOT_D, GPT_D, PT_ACT_D, Cold_Isch, Machine_SRR, Machine_NRP, Machine_DBD, NRP_Total)
```

```{r, eval=FALSE}
taxa_corrected_donante_lp <- ConQuR(tax_tab=taxa_lp, batchid=batchid_lp, covariates=covar_donante_lp, batch_ref="RUN 46", num_core = num_cores-2)

saveRDS(taxa_corrected_donante_lp, "taxa_corrected_donante_lp.RDS")
```

```{r}
taxa_corrected_donante_lp <- readRDS("taxa_corrected_donante_lp.RDS")
par(mfrow=c(2, 2))

Plot_PCoA(TAX=taxa_lp, factor=batchid_lp, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_corrected_donante_lp, factor=batchid_lp, main="ConQuR (Default), Bray-Curtis")

Plot_PCoA(TAX=taxa_lp, factor=batchid_lp, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_corrected_donante_lp, factor=batchid_lp, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")

```

```{r}
permanova_taxa_corrected_donante_lp <- PERMANOVA_R2(TAX=taxa_corrected_donante_lp, batchid=batchid_lp, covariates=covar_donante_lp, key_index=1)

permanovas["LP variables donante",1] = permanova_taxa_corrected_donante_lp$tab_count[1,1]
permanovas["LP variables donante",2] = permanova_taxa_corrected_donante_lp$tab_count[2,1]
permanovas["LP variables donante",3] = permanova_taxa_corrected_donante_lp$tab_rel[1,1]
permanovas["LP variables donante",4] = permanova_taxa_corrected_donante_lp$tab_rel[2,1]

reactable::reactable(round(permanovas, 3)*100)
```

### Datos donante filtrado

```{r}
# Ahora las covariables
covar_donante_2_lp <- covar_lp %>%
    dplyr::select(Donación, Sexo_D, Edad_D, BMI_D)
```

```{r, eval=FALSE}
taxa_corrected_donante_2_lp <- ConQuR(tax_tab=taxa_lp, batchid=batchid_lp, covariates=covar_donante_2_lp, batch_ref="RUN 46", num_core = num_cores-2)

saveRDS(taxa_corrected_donante_2_lp, "taxa_corrected_donante_2_lp.RDS")
```

```{r}
taxa_corrected_donante_2_lp <- readRDS("taxa_corrected_donante_2_lp.RDS")
par(mfrow=c(2, 2))

Plot_PCoA(TAX=taxa_lp, factor=batchid_lp, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_corrected_donante_2_lp, factor=batchid_lp, main="ConQuR (Default), Bray-Curtis")

Plot_PCoA(TAX=taxa_lp, factor=batchid_lp, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_corrected_donante_2_lp, factor=batchid_lp, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")

```

```{r}
permanova_taxa_corrected_donante_2_lp <- PERMANOVA_R2(TAX=taxa_corrected_donante_2_lp, batchid=batchid_lp, covariates=covar_donante_2_lp, key_index=1)

permanovas["LP Donación, Sexo_D, Edad_D, BMI_D",1] = permanova_taxa_corrected_donante_2_lp$tab_count[1,1]
permanovas["LP Donación, Sexo_D, Edad_D, BMI_D",2] = permanova_taxa_corrected_donante_2_lp$tab_count[2,1]
permanovas["LP Donación, Sexo_D, Edad_D, BMI_D",3] = permanova_taxa_corrected_donante_2_lp$tab_rel[1,1]
permanovas["LP Donación, Sexo_D, Edad_D, BMI_D",4] = permanova_taxa_corrected_donante_2_lp$tab_rel[2,1]

reactable::reactable(round(permanovas, 3)*100)
```

### Supervivencia con datos donante

```{r}
# Ahora las covariables
covar_supervivencia_lp <- covar_lp %>%
    dplyr::select(Donación, Sexo_D, Edad_D, BMI_D, Supervivencia)
```

```{r, eval=FALSE}
taxa_corrected_supervivencia_lp <- ConQuR(tax_tab=taxa_lp, batchid=batchid_lp, covariates=covar_supervivencia_lp, batch_ref="RUN 46", num_core = num_cores-2)

saveRDS(taxa_corrected_supervivencia_lp, "../RDSs/taxa_corrected_supervivencia_lp.RDS")
```

```{r}
taxa_corrected_supervivencia_lp <- readRDS("../RDSs/taxa_corrected_supervivencia_lp.RDS")

par(mfrow=c(2, 2))

Plot_PCoA(TAX=taxa_lp, factor=batchid_lp, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_corrected_supervivencia_lp, factor=batchid_lp, main="ConQuR (Default), Bray-Curtis")

Plot_PCoA(TAX=taxa_lp, factor=batchid_lp, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_corrected_supervivencia_lp, factor=batchid_lp, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")

```

```{r}
permanova_taxa_corrected_supervivencia_lp <- PERMANOVA_R2(TAX=taxa_corrected_supervivencia_lp, batchid=batchid_lp, covariates=covar_supervivencia_lp, key_index=1)

permanovas["Supervivencia, Donación, Sexo_D, Edad_D, BMI_D (LP)",1] = permanova_taxa_corrected_supervivencia_lp$tab_count[1,1]
permanovas["Supervivencia, Donación, Sexo_D, Edad_D, BMI_D (LP)",2] = permanova_taxa_corrected_supervivencia_lp$tab_count[2,1]
permanovas["Supervivencia, Donación, Sexo_D, Edad_D, BMI_D (LP)",3] = permanova_taxa_corrected_supervivencia_lp$tab_rel[1,1]
permanovas["Supervivencia, Donación, Sexo_D, Edad_D, BMI_D (LP)",4] = permanova_taxa_corrected_supervivencia_lp$tab_rel[2,1]

reactable::reactable(round(permanovas, 3)*100)
```

### Variables de Salida

```{r}
# Ahora las covariables
covar_salida_lp <- covar_lp %>%
    dplyr::select(Supervivencia, MEAF_score, AR, AHT, Biliary_complications)
```

```{r, eval=FALSE}
taxa_corrected_salida_lp <- ConQuR(tax_tab=taxa_lp, batchid=batchid_lp, covariates=covar_salida_lp, batch_ref="RUN 46", num_core = num_cores-2)

saveRDS(taxa_corrected_salida_lp, "../RDSs/taxa_corrected_salida_lp.RDS")
```

```{r}
taxa_corrected_salida_lp <- readRDS("../RDSs/taxa_corrected_salida_lp.RDS")

par(mfrow=c(2, 2))

Plot_PCoA(TAX=taxa_lp, factor=batchid_lp, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_corrected_salida_lp, factor=batchid_lp, main="ConQuR (Default), Bray-Curtis")

Plot_PCoA(TAX=taxa_lp, factor=batchid_lp, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_corrected_salida_lp, factor=batchid_lp, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")

```

```{r}
permanova_taxa_corrected_salida_lp <- PERMANOVA_R2(TAX=taxa_corrected_salida_lp, batchid=batchid_lp, covariates=covar_salida_lp, key_index=1)

permanovas["Supervivencia, MEAF_score, AR, AHT, Biliary_complications (LP)",1] = permanova_taxa_corrected_salida_lp$tab_count[1,1]
permanovas["Supervivencia, MEAF_score, AR, AHT, Biliary_complications (LP)",2] = permanova_taxa_corrected_salida_lp$tab_count[2,1]
permanovas["Supervivencia, MEAF_score, AR, AHT, Biliary_complications (LP)",3] = permanova_taxa_corrected_salida_lp$tab_rel[1,1]
permanovas["Supervivencia, MEAF_score, AR, AHT, Biliary_complications (LP)",4] = permanova_taxa_corrected_salida_lp$tab_rel[2,1]

reactable::reactable(round(permanovas, 3)*100)
```

# Fine tunning

## Manual del run

### Datos donante filtrado

```{r, eval=FALSE}
for (i in levels(batchid)){
    print(paste0("Analizando run = ", i))
    
    tryCatch({
        taxa_coregida <- ConQuR(tax_tab=taxa, 
                            batchid=batchid, 
                            covariates=covar_donante_2, 
                            batch_ref=i)
        
        permanova <- PERMANOVA_R2(TAX= taxa_coregida, 
                                  batchid=batchid,
                                  covariates=covar_donante_2, 
                                  key_index=1)
        
        nombre_base <- paste0(i, " Donación, Sexo_D, Edad_D, BMI_D")
        
        permanovas[nombre_base,1] = permanova$tab_count[1,1]
        permanovas[nombre_base,2] = permanova$tab_count[2,1]
        permanovas[nombre_base,3] = permanova$tab_rel[1,1]
        permanovas[nombre_base,4] = permanova$tab_rel[2,1]
        
        
    }, error = function(e) {
        # Manejo del error, imprime un mensaje y continúa
        print(paste("Error en el RUN = ", i, ":", e$message))
    })

}

saveRDS(permanovas, "permanovas.RDS")
```

```{r}
permanovas <- readRDS("permanovas.RDS")

reactable::reactable(round(permanovas, 3)*100)
```

```{r}
taxa_coregida_pgm135 <- ConQuR(tax_tab=taxa, 
                            batchid=batchid, 
                            covariates=covar_donante_2, 
                            batch_ref="PGM 135")

par(mfrow=c(2, 2))
Plot_PCoA(TAX=taxa, factor=batchid, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_coregida_pgm135, factor=batchid, main="ConQuR (Default), Bray-Curtis")

Plot_PCoA(TAX=taxa, factor=batchid, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_coregida_pgm135, factor=batchid, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")
```

### Supervivencia y datos donante filtrado

#### Todas muestras

```{r, eval=FALSE}
for (i in levels(batchid)){
    print(paste0("Analizando run = ", i))
    
    tryCatch({
        taxa_coregida <- ConQuR(tax_tab=taxa, 
                            batchid=batchid, 
                            covariates=covar_supervivencia_2, 
                            batch_ref=i)
        
        permanova <- PERMANOVA_R2(TAX= taxa_coregida, 
                                  batchid=batchid,
                                  covariates=covar_supervivencia_2, 
                                  key_index=1)
        
        nombre_base <- paste0(i, " Supervivencia, Donación, Sexo_D, Edad_D, BMI_D")
        
        permanovas[nombre_base,1] = permanova$tab_count[1,1]
        permanovas[nombre_base,2] = permanova$tab_count[2,1]
        permanovas[nombre_base,3] = permanova$tab_rel[1,1]
        permanovas[nombre_base,4] = permanova$tab_rel[2,1]
        
        
    }, error = function(e) {
        # Manejo del error, imprime un mensaje y continúa
        print(paste("Error en el RUN = ", i, ":", e$message))
    })

}

saveRDS(permanovas, "permanovas.RDS")
```

```{r, fig.width=10}
permanovas <- readRDS("permanovas.RDS")

DT::datatable(round(permanovas, 3)*100)
```

```{r}
taxa_coregida_pgm135 <- ConQuR(tax_tab=taxa, 
                            batchid=batchid, 
                            covariates=covar_donante_2, 
                            batch_ref="PGM 135")

par(mfrow=c(2, 2))
Plot_PCoA(TAX=taxa, factor=batchid, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_coregida_pgm135, factor=batchid, main="ConQuR (Default), Bray-Curtis")

Plot_PCoA(TAX=taxa, factor=batchid, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_coregida_pgm135, factor=batchid, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")
```

#### LP

```{r, eval=FALSE}
for (i in levels(batchid_lp)){
    print(paste0("Analizando run = ", i))
    
    tryCatch({
        taxa_coregida <- ConQuR(tax_tab=taxa_lp, 
                            batchid=batchid_lp, 
                            covariates=covar_salida_lp, 
                            batch_ref=i)
        
        permanova <- PERMANOVA_R2(TAX= taxa_coregida, 
                                  batchid=batchid_lp,
                                  covariates=covar_salida_lp, 
                                  key_index=1)
        
        nombre_base <- paste0(i, " Supervivencia, MEAF_score, AR, AHT, Biliary_complications (LP)")
        
        permanovas[nombre_base,1] = permanova$tab_count[1,1]
        permanovas[nombre_base,2] = permanova$tab_count[2,1]
        permanovas[nombre_base,3] = permanova$tab_rel[1,1]
        permanovas[nombre_base,4] = permanova$tab_rel[2,1]
        
        
    }, error = function(e) {
        # Manejo del error, imprime un mensaje y continúa
        print(paste("Error en el RUN = ", i, ":", e$message))
    })

}

saveRDS(permanovas, "permanovas.RDS")
```

```{r, fig.width=10}
permanovas <- readRDS("permanovas.RDS")

DT::datatable(round(permanovas, 3)*100) 
```

```{r}
taxa_coregida_pgm135 <- ConQuR(tax_tab=taxa_lp, 
                            batchid=batchid_lp, 
                            covariates=covar_salida_lp, 
                            batch_ref="PGM 140")

par(mfrow=c(2, 2))
Plot_PCoA(TAX=taxa_lp, factor=batchid_lp, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_coregida_pgm135, factor=batchid_lp, main="ConQuR (Default), Bray-Curtis")

Plot_PCoA(TAX=taxa_lp, factor=batchid_lp, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_coregida_pgm135, factor=batchid_lp, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")
```


### Lasso penalty

```{r, eval=FALSE}
options(warn=-1)
taxa_corrected2_lasso = ConQuR(tax_tab=taxa_lp, 
                         batchid=batchid_lp, 
                         covariates=covar_supervivencia_lp, 
                         batch_ref="PGM 135",
                         logistic_lasso=T, 
                         quantile_type="lasso", 
                         interplt=T,
                         lambda_quantile="2p/logn")

saveRDS(taxa_corrected2_lasso, "taxa_corrected2_lasso.RDS")
```

```{r}
taxa_corrected2_lasso <- readRDS("taxa_corrected2_lasso.RDS")
par(mfrow=c(2, 2))

Plot_PCoA(TAX=taxa, factor=batchid, main="Before Correction, Bray-Curtis")
Plot_PCoA(TAX=taxa_coregida_pgm135, factor=batchid, main="ConQuR (Default), Bray-Curtis")
Plot_PCoA(TAX=taxa_corrected2_lasso, factor=batchid, main="ConQuR (Lasso penalty), Bray-Curtis")

Plot_PCoA(TAX=taxa, factor=batchid, dissimilarity="Aitch", main="Before Correction, Aitchison")
Plot_PCoA(TAX=taxa_corrected2_lasso, factor=batchid, dissimilarity="Aitch", main="ConQuR (Default), Aitchison")
Plot_PCoA(TAX=taxa_coregida_pgm135, factor=batchid, dissimilarity="Aitch", main="ConQuR (Lasso penalty), Aitchison")

```

```{r}
permanova_taxa_corrected_donante_2 <- PERMANOVA_R2(TAX=taxa_corrected_donante_2, batchid=batchid, covariates=covar_donante_2, key_index=1)

permanovas["Donación, Sexo_D, Edad_D, BMI_D",1] = permanova_taxa_corrected_donante_2$tab_count[1,1]
permanovas["Donación, Sexo_D, Edad_D, BMI_D",2] = permanova_taxa_corrected_donante_2$tab_count[2,1]
permanovas["Donación, Sexo_D, Edad_D, BMI_D",3] = permanova_taxa_corrected_donante_2$tab_rel[1,1]
permanovas["Donación, Sexo_D, Edad_D, BMI_D",4] = permanova_taxa_corrected_donante_2$tab_rel[2,1]

reactable::reactable(round(permanovas, 3)*100)
```



## Automatica

```{r}
# result_tuned <- Tune_ConQuR(tax_tab=taxa, 
#                            batchid=batchid, 
#                            covariates=covar_donante_2,
#                            batch_ref_pool=c("RUN 46", "PGM 135"),
#                            logistic_lasso_pool=c(T, F), 
#                            quantile_type_pool=c("standard", "lasso"),
#                            simple_match_pool=c(T, F),
#                            lambda_quantile_pool=c(NA, "2p/n", "2p/logn"),
#                            interplt_pool=c(T, F),
#                            frequencyL=0,
#                            frequencyU=1,
#                            num_core = num_cores-2)

```

